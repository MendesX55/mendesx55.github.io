<!DOCTYPE html>
<html lang="en">
<head>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<link href="icon.png" rel="apple-touch-icon"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Tour Management - Sean Paul √ó Wiz Khalifa √ó DaBaby</title>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); }
        body { font-family: 'Arial', sans-serif; color: #fff; min-height: 100vh; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
        .header { background: linear-gradient(90deg, #ff6b35, #f7931e, #ffd700); padding: 15px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.6em; font-weight: bold; color: #000; text-shadow: 2px 2px 4px rgba(255,255,255,0.3); margin-bottom: 5px; }
        .artist-logos { display: flex; justify-content: center; gap: 10px; margin-top: 8px; }
        .logo-placeholder { width: 80px; height: 35px; background: linear-gradient(45deg, #000, #333); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 9px; color: #ffd700; border: 1px solid #ffd700; }
        .container { max-width: 430px; margin: 0 auto; height: calc(100vh - 120px); display: flex; flex-direction: column; }
        .tab-navigation { display: flex; background: rgba(255,255,255,0.1); border-radius: 15px 15px 0 0; margin: 10px 10px 0 10px; overflow: hidden; }
        .tab-btn { flex: 1; padding: 8px 6px; background: transparent; border: none; color: #ccc; font-weight: bold; font-size: 10px; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; text-align: center; }
        .tab-btn span { font-size: 1.5em; }
        .tab-btn.active { background: rgba(255,215,0,0.2); color: #ffd700; border-bottom: 3px solid #ffd700; }
        .tab-content { flex: 1; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); margin: 0 10px 10px 10px; border-radius: 0 0 15px 15px; padding: 15px; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        .form-section { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .form-section h3 { color: #ffd700; margin-bottom: 12px; font-size: 1.1em; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 5px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; color: #fff; font-weight: bold; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.9); color: #000; font-size: 16px; -webkit-appearance: none; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .currency-input { position: relative; }
        .currency-prefix { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; pointer-events: none; z-index: 1; }
        .currency-input input { padding-left: 30px; }
        .btn { background: linear-gradient(45deg, #ff6b35, #f7931e); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s ease; margin: 5px 0; width: 100%; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: scale(0.98); }
        .btn-small { padding: 6px 12px; font-size: 11px; width: auto; }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .route-item { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #87CEEB; }
        .route-item.show-day { border-left-color: #ff6b35; }
        .route-item.cached { border-left-color: #4CAF50; }
        .route-item.error { border-left-color: #e74c3c; }
        .stats-grid { display: grid; gap: 8px; margin-bottom: 15px; }
        .stats-grid-2-col { grid-template-columns: 1fr 1fr; }
        .stats-grid-3-col { grid-template-columns: 1fr 1fr 1fr; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #ffd700; margin-bottom: 3px; }
        .stat-label { color: #ccc; font-size: 0.8em; }
        .venue-card, .hotel-card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #ffd700; cursor: pointer; transition: all 0.3s ease; }
        .venue-card:hover, .hotel-card:hover { background: rgba(255,215,0,0.1); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
        .card-title { color: #ffd700; font-weight: bold; flex-grow: 1; word-break: break-word; }
        .card-date { font-weight: bold; color: #fff; white-space: nowrap; flex-shrink: 0; font-size: 11px; }
        .summary-box { background: #16213e; border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px; position: sticky; top: -15px; z-index: 10; }
        .day-summary-box { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; padding: 12px; margin-top: 20px; margin-bottom: 10px; }
        .day-summary-box h4 { color: #ffd700; text-align: center; margin-bottom: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); margin: 10% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid rgba(255,215,0,0.3); max-height: 80vh; overflow-y: auto; }
        .modal-header { color: #ffd700; font-size: 1.3em; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #ffd700; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-nav { background: none; border: none; color: #ffd700; font-size: 2em; cursor: pointer; padding: 0 10px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #fff; }
        .route-selector { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .route-selector h3 { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        #route-builder-content.collapsed { display: none; }
        .toggle-arrow { font-size: 1.2em; transition: transform 0.3s ease; }
        .toggle-arrow.collapsed { transform: rotate(-90deg); }
        .route-controls-bottom { display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px; }
        .route-step { display: flex; align-items: center; margin-bottom: 10px; }
        .route-step-number { background: #ffd700; color: #000; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; flex-shrink: 0; }
        .route-step select { flex-grow: 1; flex-shrink: 1; min-width: 0; padding: 8px; border-radius: 6px; border: none; background: rgba(255,255,255,0.9); color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .progress-bar-container { position: relative; }
        .progress-bar { background: rgba(255,255,255,0.1); border-radius: 10px; height: 20px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 20px; font-size: 11px; font-weight: bold; color: #fff; top: 0; left: 0; }
        input[type="date"], input[type="time"], input[type="number"], select { height: 42px !important; font-size: 16px; padding: 10px; box-sizing: border-box; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .checkbox-item { display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; }
        .checkbox-item input { width: 20px; height: 20px; margin-right: 10px; }
        .settings-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: end; }
        .settings-row .form-group { margin-bottom: 0; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #calendar-header button { background: #ff6b35; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        #month-year { font-size: 1.2em; font-weight: bold; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); min-height: 80px; border-radius: 8px; padding: 5px; font-size: 0.8em; cursor: pointer; transition: background-color 0.3s; }
        .calendar-day:hover { background: rgba(255,215,0,0.2); }
        .calendar-day.other-month { background: rgba(0,0,0,0.1); color: #666; }
        .day-number { font-weight: bold; }
        .day-events { font-size: 1.5em; line-height: 1; margin-top: 5px; }
        .day-note { font-size: 9px; font-style: italic; color: #ccc; margin-top: 5px; }
        .currency-input input { width: 100%; min-width: 0; max-width: 100%; box-sizing: border-box; }

        /* VISUAL FIX FOR IPHONE 16 PRO MAX WITH ZOOMED PROFILE */
        @media only screen and (max-width: 430px) and (min-device-pixel-ratio: 3) {
            .tab-btn {
                font-size: 9px; /* Slightly smaller text for tabs */
                padding: 6px 3px; /* Tighter padding */
            }
            .tab-btn span {
                font-size: 1.3em; /* Slightly smaller icon */
            }
            .stat-value {
                font-size: 1.1em; /* Reduce value font size */
                white-space: nowrap; /* Prevent "12000 KM" from breaking */
            }
             .stat-label {
                font-size: 0.75em; /* Reduce label font size */
            }
        }
</style>
</head>
<body>
<div style="padding: 10px 20px; background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);">
<a href="index.html" style="text-decoration: none; color: #ff6b35; font-size: 1.5em;">‚Üê Back</a>
</div>
<div class="header">
<h1>üé§ TOUR MANAGER üé§</h1>
<div class="artist-logos">
<div class="logo-placeholder">SEAN PAUL</div>
<div class="logo-placeholder">WIZ KHALIFA</div>
<div class="logo-placeholder">DABABY</div>
</div>
</div>
<div class="container">
<div class="tab-navigation">
<button class="tab-btn active" onclick="showTab('calendar')"><span>üóìÔ∏è</span>CALENDAR</button>
<button class="tab-btn" onclick="showTab('venues')"><span>üéµ</span>VENUES</button>
<button class="tab-btn" onclick="showTab('hotels')"><span>üè®</span>HOTELS</button>
<button class="tab-btn" onclick="showTab('routes')"><span>üöó</span>ROUTES</button>
<button class="tab-btn" onclick="showTab('expenses')"><span>üí∞</span>EXPENSES</button>
<button class="tab-btn" onclick="showTab('settings')"><span>‚öôÔ∏è</span>SETTINGS</button>
</div>
<!-- CALENDAR TAB -->
<div class="tab-content active" id="calendar">
<div id="calendar-header">
<button onclick="prevMonth()">‚óÑ Prev</button>
<div id="month-year"></div>
<button onclick="nextMonth()">Next ‚ñ∫</button>
</div>
<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-weight: bold; color: #ffd700; font-size: 0.8em; padding-bottom: 5px;">
<div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
</div>
<div id="calendar-grid"></div>
</div>
<!-- VENUES TAB -->
<div class="tab-content" id="venues">
<div class="summary-box">
<div class="stats-grid stats-grid-2-col">
<div class="stat-card"><div class="stat-value" id="venueCountStat">0</div><div class="stat-label">Total Shows</div></div>
<div class="stat-card"><div class="stat-value" id="venueSalesStat">$0</div><div class="stat-label">Total Sales (USD)</div></div>
</div>
</div>
<div id="venuesList"></div>
</div>
<!-- HOTELS TAB -->
<div class="tab-content" id="hotels">
<div class="summary-box">
<div class="stats-grid stats-grid-3-col">
<div class="stat-card"><div class="stat-value" id="hotelCountStat">0</div><div class="stat-label">Total Hotels</div></div>
<div class="stat-card"><div class="stat-value" id="hotelDaysStat">0</div><div class="stat-label">Total Days</div></div>
<div class="stat-card"><div class="stat-value" id="hotelCostStat">$0</div><div class="stat-label">Total Cost</div></div>
</div>
</div>
<div id="hotelsList"></div>
</div>
<!-- ROUTES TAB -->
<div class="tab-content" id="routes">
<div class="summary-box">
<div class="stats-grid stats-grid-3-col">
<div class="stat-card"><div class="stat-value" id="totalDistanceStat">0 km</div><div class="stat-label">Total Distance</div></div>
<div class="stat-card"><div class="stat-value" id="totalTimeStat">0h</div><div class="stat-label">Drive Time</div></div>
<div class="stat-card"><div class="stat-value" id="totalGasStat">$0</div><div class="stat-label">Est. Gas</div></div>
</div>
</div>
<div class="route-selector">
<h3 onclick="toggleRouteBuilder()">üó∫Ô∏è Build Full Tour Itinerary <span class="toggle-arrow" id="routeBuilderToggleArrow">‚ñº</span></h3>
<div id="route-builder-content">
<div id="routeSteps"></div>
<div class="route-controls-bottom"><button class="btn btn-small" onclick="addRouteStop()">+ Add Stop</button><button class="btn btn-small" onclick="removeRouteStop()">- Remove Stop</button><button class="btn btn-small" onclick="clearAllStops()">Clear All</button><button class="btn btn-small" onclick="autoFillRoute()">Auto-Fill</button></div>
</div>
<button class="btn" id="generateRouteBtn" onclick="generateCustomRoute()">üõ£Ô∏è Generate Full Tour Route</button>
<div class="progress-bar-container" id="routeProgress" style="display: none;">
<div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
<div class="progress-text" id="progressText">Preparing...</div>
</div>
<div style="text-align: center; margin-top: 10px;"><span id="routeStopCount" style="color: #ffd700; font-size: 12px;">Stops: 0 / Unlimited</span></div>
</div>
<div id="routeResults"></div>
</div>
<!-- EXPENSES TAB -->
<div class="tab-content" id="expenses">
<div class="summary-box">
<div class="stats-grid stats-grid-2-col">
<div class="stat-card"><div class="stat-value" id="expenseCountStat">0</div><div class="stat-label">Total Expenses</div></div>
<div class="stat-card"><div class="stat-value" id="expenseCostStat">$0</div><div class="stat-label">Total Cost</div></div>
</div>
</div>
<table id="expensesTable" style="width:100%; border-collapse: collapse;"><thead style="font-size:12px"><tr><th style="padding:8px;text-align:left">Date</th><th style="padding:8px;text-align:left">Type</th><th style="padding:8px;text-align:left">Location</th><th style="padding:8px;text-align:left">USD</th><th style="padding:8px;text-align:left">CAD</th><th style="padding:8px;text-align:left">Action</th></tr></thead><tbody id="expensesBody" style="font-size:11px"></tbody></table>
</div>
<!-- SETTINGS (INPUT) TAB -->
<div class="tab-content" id="settings">
<div class="form-section"><h3>üè® Hotel Confirmations</h3><div class="form-group"><label>Hotel Name</label><input id="hotelName" placeholder="Hotel name" type="text"/></div><div class="form-group"><label>Address</label><input id="hotelAddress" placeholder="Full address" type="text"/></div><div class="form-row"><div class="form-group"><label>Check-in</label><input id="checkinDate" type="date"/></div><div class="form-group"><label>Check-out</label><input id="checkoutDate" type="date"/></div></div><div class="form-row-2"><div class="form-group currency-input"><label>USD Cost</label><span class="currency-prefix">$</span><input id="hotelCostUSD" placeholder="0.00" step="0.01" type="number"/></div><div class="form-group currency-input"><label>Manual CAD</label><span class="currency-prefix">$</span><input id="hotelCostCAD" placeholder="0.00" step="0.01" type="number"/></div></div><div class="form-group"><label>Confirmation Notes</label><textarea id="hotelNotes" placeholder="Confirmation number, special requests, etc." rows="2"></textarea></div><button class="btn" onclick="addHotel()">Add Hotel</button></div>
<div class="form-section"><h3>üéµ Venue Information</h3><div class="form-group"><label>Venue Name</label><input id="venueName" placeholder="Venue name" type="text"/></div><div class="form-group"><label>Address</label><input id="venueAddress" placeholder="Full address" type="text"/></div><div class="form-row"><div class="form-group"><label>Show Date</label><input id="showDate" type="date"/></div><div class="form-group"><label>Show Time</label><input id="showTime" type="time"/></div></div><div class="form-row-3"><div class="form-group"><label>Start Inventory</label><input id="startInventory" placeholder="0" type="number"/></div><div class="form-group"><label>End Inventory</label><input id="endInventory" placeholder="0" type="number"/></div><div class="form-group currency-input"><label>Sales (USD)</label><span class="currency-prefix">$</span><input id="totalSales" placeholder="0.00" step="0.01" type="number"/></div></div><div class="form-group"><label>Venue Notes</label><textarea id="venueNotes" placeholder="Stage setup, sound requirements, etc." rows="2"></textarea></div><button class="btn" onclick="addVenue()">Add Venue</button></div>
<div class="form-section"><h3>üí∞ Expenses</h3><div class="form-row"><div class="form-group"><label>Type</label><select id="expenseType"><option value="gas">Gas</option><option value="food">Food</option><option value="tolls">Tolls</option><option value="parking">Parking</option><option value="misc">Miscellaneous</option></select></div><div class="form-group"><label>Date</label><input id="expenseDate" type="date"/></div></div><div class="form-group"><label>Location</label><input id="expenseLocation" placeholder="Where was this expense?" type="text"/></div><div class="form-row-2"><div class="form-group currency-input"><label>USD Cost</label><span class="currency-prefix">$</span><input id="expenseAmountUSD" placeholder="0.00" step="0.01" type="number"/></div><div class="form-group currency-input"><label>Manual CAD</label><span class="currency-prefix">$</span><input id="expenseAmountCAD" placeholder="0.00" step="0.01" type="number"/></div></div><div class="form-group"><label>Notes</label><textarea id="expenseNotes" placeholder="Additional notes" rows="2"></textarea></div><button class="btn" onclick="addExpense()">Add Expense</button></div>
<div class="form-section"><h3>‚öôÔ∏è App Settings</h3><p style="font-size: 13px; color: #ccc; margin-bottom: 10px;">Configure gas cost calculations.</p>
<div class="settings-row">
<div class="form-group"><label for="kmPerLitre">Fuel KM/L</label><input id="kmPerLitre" placeholder="e.g. 8" type="number"/></div>
<div class="form-group"><label for="costPerLitre">Cost $/L</label><input id="costPerLitre" placeholder="e.g. 1.75" type="number"/></div>
<div class="form-group"><label for="heavyFootPercent">Go FAST %</label><input id="heavyFootPercent" placeholder="e.g. 10" type="number"/></div>
</div>
<button class="btn" onclick="applySettings()" style="margin-top: 15px;">Apply Settings</button>
</div>
<div class="form-section"><h3>üì• Import from CSV</h3><p style="font-size: 13px; color: #ccc; margin-bottom: 10px;">Restore data from your spreadsheet backups. Import main data FIRST.</p><input type="file" id="mainDataImporter" accept=".csv" style="display: none;" onchange="handleFileSelect('main')"/><label for="mainDataImporter" class="btn">Import Hotels, Venues, Expenses</label><input type="file" id="routeDataImporter" accept=".csv" style="display: none;" onchange="handleFileSelect('route')"/><label for="routeDataImporter" class="btn" style="margin-top: 10px;">Import Route Itinerary</label><p id="importStatus" style="font-size: 12px; text-align: center; color: #4CAF50; margin-top: 10px;"></p></div>
<div class="form-section"><h3>üì§ Data Management</h3><p style="font-size: 13px; color: #ccc; margin-bottom: 10px;">Export data or sync with the cloud.</p>
<div class="checkbox-group">
<label class="checkbox-item"><input checked id="exportHotels" type="checkbox"/> Hotels</label>
<label class="checkbox-item"><input checked id="exportVenues" type="checkbox"/> Venues</label>
<label class="checkbox-item"><input checked id="exportExpenses" type="checkbox"/> Expenses</label>
<label class="checkbox-item"><input id="exportRoute" type="checkbox"/> Full Route Itinerary</label>
</div>
<button class="btn" onclick="exportTourData()">Export Selected Data to CSV</button>
<button class="btn" onclick="uploadLocalToFirebase()" style="margin-top: 10px;">Upload Local ‚Üí Firebase</button>
<p id="syncStatus" style="font-size: 12px; text-align: center; color: #ccc; margin-top: 10px;"></p>
</div>
</div>
</div>
<!-- MODALS -->
<div class="modal" id="hotelModal"><div class="modal-content"><div class="modal-header"><span class="close" onclick="closeModal('hotelModal')">√ó</span><div>Edit Hotel Details</div></div><div id="hotelEditForm"><div class="form-group"><label>Hotel Name</label><input id="editHotelName" type="text"/></div><div class="form-group"><label>Address</label><input id="editHotelAddress" type="text"/></div><div class="form-row"><div class="form-group"><label>Check-in</label><input id="editCheckinDate" type="date"/></div><div class="form-group"><label>Check-out</label><input id="editCheckoutDate" type="date"/></div></div><div class="form-row-2"><div class="form-group currency-input"><label>USD Cost</label><span class="currency-prefix">$</span><input id="editHotelCostUSD" step="0.01" type="number"/></div><div class="form-group currency-input"><label>CAD Cost</label><span class="currency-prefix">$</span><input id="editHotelCostCAD" step="0.01" type="number"/></div></div><div class="form-group"><label>Confirmation Notes</label><textarea id="editHotelNotes" rows="3"></textarea></div><button class="btn" onclick="saveHotelEdit()">Save Changes</button><button class="btn btn-danger" onclick="deleteHotel()">Delete Hotel</button></div></div></div>
<div class="modal" id="venueModal"><div class="modal-content"><div class="modal-header"><span class="close" onclick="closeModal('venueModal')">√ó</span><div>Edit Venue Details</div></div><div id="venueEditForm"><div class="form-group"><label>Venue Name</label><input id="editVenueName" type="text"/></div><div class="form-group"><label>Address</label><input id="editVenueAddress" type="text"/></div><div class="form-row"><div class="form-group"><label>Show Date</label><input id="editShowDate" type="date"/></div><div class="form-group"><label>Show Time</label><input id="editShowTime" type="time"/></div></div><div class="form-row-3"><div class="form-group"><label>Start Inventory</label><input id="editStartInventory" type="number"/></div><div class="form-group"><label>End Inventory</label><input id="editEndInventory" type="number"/></div><div class="form-group currency-input"><label>Sales (USD)</label><span class="currency-prefix">$</span><input id="editTotalSales" step="0.01" type="number"/></div></div><div class="form-group"><label>Venue Notes</label><textarea id="editVenueNotes" rows="3"></textarea></div><button class="btn" onclick="saveVenueEdit()">Save Changes</button><button class="btn btn-danger" onclick="deleteVenue()">Delete Venue</button></div></div></div>
<div class="modal" id="calendarModal"><div class="modal-content" id="calendarModalContent"></div></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
    // --- App Configuration ---
    const GOOGLE_MAPS_API_KEY = 'AIzaSyDk14v_vZFteu3J3ltcs5jXu03AiVqZUZc';
    const TOUR_NAME = "seanpaul";
    const OLD_STORAGE_KEY = 'tourData'; 
    const STORAGE_KEY = `tourData_${TOUR_NAME}`;
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBpv5P-dtJnJMOG3uugWyv70mQdkz5iuCo",
      authDomain: "tour-manager-b2888.firebaseapp.com",
      projectId: "tour-manager-b2888",
    };

    // --- Global State ---
    let tourData = {};
    let db;
    let currentEditId = null;
    let routeStopCounter = 0;
    let isGeneratingRoute = false;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let currentModalDate = null;

    // --- Core App Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        try {
            if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.firestore();
        } catch (e) { console.error("Firebase initialization failed:", e); }
        loadInitialData();
    });

    async function loadInitialData() {
        let loadedFromSource = 'Default';
        let dataToLoad = {};
        if (db) {
            try {
                const doc = await db.collection("tourData").doc(STORAGE_KEY).get();
                if (doc.exists) { dataToLoad = doc.data(); loadedFromSource = 'Firebase'; }
            } catch (error) { console.error("Firebase fetch failed, trying local.", error); }
        }
        if (loadedFromSource === 'Default') {
            const localData = localStorage.getItem(STORAGE_KEY);
            if (localData) { try { dataToLoad = JSON.parse(localData); loadedFromSource = 'LocalStorage'; } catch(e) { console.error("Local data parse failed", e); } }
        }
        tourData = { hotels: [], venues: [], expenses: [], routePlannerState: [], routeCache: {}, settings: { kmPerLitre: 8.5, costPerLitre: 1.75, heavyFootPercent: 10 }, ...dataToLoad };
        console.log(`Data loaded from: ${loadedFromSource}`);
        initializeAppUI();
    }

    function initializeAppUI() {
        if (!tourData.routePlannerState) tourData.routePlannerState = [];
        loadRoutePlannerState();
        showTab('calendar');
        const syncStatusEl = document.getElementById('syncStatus');
        if(syncStatusEl) syncStatusEl.textContent = `‚òÅÔ∏è Data loaded.`;
    }
    
    // --- Data Persistence ---
    function saveData() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tourData));
            if (db) {
                db.collection("tourData").doc(STORAGE_KEY).set(tourData).then(() => {
                    const syncStatusEl = document.getElementById('syncStatus');
                    if(syncStatusEl) syncStatusEl.textContent = `‚òÅÔ∏è Synced: ${new Date().toLocaleTimeString()}`;
                }).catch((error) => console.error("Firebase sync failed:", error));
            }
        } catch (e) { console.error("Save failed:", e); }
    }
    
    function uploadLocalToFirebase() {
        const localDataString = localStorage.getItem(STORAGE_KEY);
        if (!localDataString) return alert("No local data found to upload.");
        if (!db) return alert("Firebase is not connected.");
        if (!confirm("This will overwrite cloud data with the data from this device. Are you sure?")) return;
        try {
            db.collection("tourData").doc(STORAGE_KEY).set(JSON.parse(localDataString))
              .then(() => alert("Local data successfully uploaded to Firebase!"))
              .catch((error) => alert(`Upload failed: ${error.message}`));
        } catch(e) { alert(`Error reading local data: ${e.message}`); }
    }

    // --- CSV Importer ---
    function handleFileSelect(type) {
        const input = (type === 'main') ? document.getElementById('mainDataImporter') : document.getElementById('routeDataImporter');
        if (!input || !input.files || input.files.length === 0) return;
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            const csv = event.target.result;
            if (type === 'main') processMainDataCsv(csv);
            else processRouteDataCsv(csv);
        };
        reader.readAsText(file);
        input.value = '';
    }

    function processMainDataCsv(csv) {
        const statusEl = document.getElementById('importStatus');
        try {
            const lines = csv.split('\n').filter(l => l.trim() && !l.toLowerCase().startsWith('type,date'));
            const headers = ['Type','Date','Name/Location','USD Cost','CAD Cost','Notes'];
            const data = { hotels: [], venues: [], expenses: [] };
            lines.forEach((line, i) => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                let row = headers.reduce((obj, h, index) => { obj[h] = values[index]; return obj; }, {});
                
                const notesParts = (row.Notes || '').split(' | ');
                const address = notesParts[0] || '';
                
                if (row.Type === 'Hotel') {
                    const checkoutMatch = (row.Notes || '').match(/Check-out: (\d{4}-\d{2}-\d{2})/);
                    data.hotels.push({
                        id: Date.now() + i, type: 'hotel', name: row['Name/Location'], address: address,
                        checkin: row['Date'], checkout: checkoutMatch ? checkoutMatch[1] : '',
                        costUSD: parseFloat(row['USD Cost']) || 0, costCAD: parseFloat(row['CAD Cost']) || 0, notes: row.Notes
                    });
                } else if (row.Type === 'Venue') {
                    const timeMatch = (row.Notes || '').match(/Time: ([\d:]+)/);
                    const soldMatch = (row.Notes || '').match(/Sold: (\d+)/);
                    data.venues.push({
                        id: Date.now() + i, type: 'venue', name: row['Name/Location'], address: address,
                        date: row['Date'], time: timeMatch ? timeMatch[1] : '',
                        totalSales: 0, startInventory: soldMatch ? parseInt(soldMatch[1]) : 0, endInventory: 0, notes: row.Notes
                    });
                } else if (row.Type.startsWith('Expense')) {
                    const expenseType = row.Type.split(' - ')[1] || 'misc';
                    data.expenses.push({
                        id: Date.now() + i, category: 'expense', type: expenseType, location: row['Name/Location'],
                        date: row['Date'], amountCAD: parseFloat(row['CAD Cost']) || 0, amountUSD: parseFloat(row['USD Cost']) || 0, notes: row.Notes
                    });
                }
            });
            const summary = `Found: ${data.hotels.length} hotels, ${data.venues.length} venues, ${data.expenses.length} expenses.`;
            if (confirm(`${summary}\n\nThis will REPLACE all current data. Are you sure?`)) {
                tourData.hotels = data.hotels;
                tourData.venues = data.venues;
                tourData.expenses = data.expenses;
                saveData();
                updateAllDisplays();
                statusEl.textContent = '‚úÖ Main data imported successfully!';
            } else { statusEl.textContent = 'Import cancelled.'; }
        } catch (e) { console.error(e); statusEl.textContent = '‚ùå Error parsing main CSV. Check format.'; }
    }

    function processRouteDataCsv(csv) {
        const statusEl = document.getElementById('importStatus');
        if (!tourData.hotels.length && !tourData.venues.length) { alert('Please import Main Data before importing the route itinerary.'); return; }
        try {
            const lines = csv.split('\n').filter(l => l.trim().startsWith('Segment'));
            let importedCount = 0;
            const allStops = [...tourData.hotels, ...tourData.venues];
            lines.forEach(line => {
                const v = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ''));
                const [date, fromName, toName, distText, timeText] = [v[1], v[2], v[3], v[4], v[5]];
                const fromStop = allStops.find(s => s.name.trim() === fromName.trim());
                const toStop = allStops.find(s => s.name.trim() === toName.trim());
                if (fromStop && toStop) {
                    const cacheKey = `${date}_${fromStop.address}|${toStop.address}`;
                    tourData.routeCache[cacheKey] = {
                        timestamp: Date.now(),
                        data: { isCached: true, stops: [fromStop, toStop], legs: [{ distance: { text: distText, value: parseFloat(distText) * 1000 }, duration: {text: timeText, value: 0} }], totalDistance: parseFloat(distText) * 1000, totalTime: 0 }
                    };
                    importedCount++;
                } else { console.warn(`Could not find stops: From "${fromName}" To "${toName}"`) }
            });
            saveData();
            statusEl.textContent = `‚úÖ Route cache updated with ${importedCount} segments.`;
        } catch (e) { console.error(e); statusEl.textContent = '‚ùå Error parsing route CSV.'; }
    }

    // --- UI Rendering ---
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        const tabEl = document.getElementById(tabName);
        const btnEl = document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`);
        if (tabEl) tabEl.classList.add('active');
        if (btnEl) btnEl.classList.add('active');
        updateAllDisplays();
    }
    
    function updateAllDisplays() {
        renderCalendar();
        updateVenuesDisplay();
        updateHotelsDisplay();
        updateRoutesDisplay();
        updateExpensesDisplay();
        const kmInput = document.getElementById('kmPerLitre');
        if(kmInput) {
            kmInput.value = tourData.settings.kmPerLitre || '';
            document.getElementById('costPerLitre').value = tourData.settings.costPerLitre || '';
            document.getElementById('heavyFootPercent').value = tourData.settings.heavyFootPercent || '';
        }
    }
    
    function renderCalendar() { const calendarEl = document.getElementById('calendar-grid'); const monthYearEl = document.getElementById('month-year'); if (!calendarEl || !monthYearEl) return; calendarEl.innerHTML = ''; const firstDay = new Date(currentYear, currentMonth, 1).getDay(); const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate(); monthYearEl.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`; for (let i = 0; i < firstDay; i++) { calendarEl.innerHTML += `<div class="calendar-day other-month"></div>`; } for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; let dayHtml = `<div class="calendar-day" onclick="showDayDetails('${dateStr}')"><div class="day-number">${day}</div>`; const events = getEventsForDate(dateStr); let eventIcons = ''; if (events.isVenue) eventIcons += 'üéµ'; if (events.isTravel) eventIcons += 'üöó'; dayHtml += `<div class="day-events">${eventIcons}</div>`; dayHtml += '</div>'; calendarEl.innerHTML += dayHtml; } }
    function updateVenuesDisplay() { const listEl = document.getElementById('venuesList'); if (!listEl) return; listEl.innerHTML = ''; const sortedVenues = [...tourData.venues].sort((a, b) => new Date(a.date) - new Date(b.date)); let totalSales = 0; sortedVenues.forEach(venue => { totalSales += venue.totalSales; const sold = venue.startInventory - venue.endInventory; const card = document.createElement('div'); card.className = 'venue-card'; card.onclick = () => openVenueModal(venue.id); card.innerHTML = `<div class="card-header"><strong class="card-title">${venue.name}</strong><small class="card-date">${formatDate(venue.date)} @ ${formatTime(venue.time)}</small></div><div style="color: #ccc; font-size: 12px; margin-bottom: 8px;">üìç ${venue.address.substring(0, 50)}...</div><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><span style="font-size: 12px;">Inventory: Start ${venue.startInventory} | End ${venue.endInventory} | Sold ${sold}</span></div><div style="display: flex; justify-content: space-between; align-items: center;"><span style="color: #4CAF50; font-weight: bold;">Sales: ${venue.totalSales.toLocaleString()} USD</span><button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('venue', ${venue.id})">√ó</button></div>${venue.notes ? `<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 11px;">üìù ${venue.notes}</div>` : ''}`; listEl.appendChild(card); }); document.getElementById('venueCountStat').textContent = tourData.venues.length; document.getElementById('venueSalesStat').textContent = '$' + totalSales.toLocaleString(); }
    function updateHotelsDisplay() { const listEl = document.getElementById('hotelsList'); if (!listEl) return; listEl.innerHTML = ''; const sortedHotels = [...tourData.hotels].sort((a, b) => new Date(a.checkin) - new Date(b.checkin)); let totalCAD = 0, totalNights = 0; sortedHotels.forEach(hotel => { totalCAD += hotel.costCAD || (hotel.costUSD * 1.35); if (hotel.checkin && hotel.checkout) totalNights += (new Date(hotel.checkout) - new Date(hotel.checkin)) / 86400000; const displayCAD = hotel.costCAD > 0 ? hotel.costCAD : (hotel.costUSD * 1.35); const card = document.createElement('div'); card.className = 'hotel-card'; card.onclick = () => openHotelModal(hotel.id); card.innerHTML = `<div class="card-header"><strong class="card-title">${hotel.name}</strong><small class="card-date">${formatDate(hotel.checkin)} - ${formatDate(hotel.checkout)}</small></div><div style="color: #ccc; font-size: 12px; margin-bottom: 8px;">üìç ${hotel.address.substring(0, 50)}...</div><div style="display: flex; justify-content: space-between; align-items: center;"><span>USD: ${hotel.costUSD.toFixed(0)} | CAD: ${displayCAD.toFixed(0)}${hotel.costCAD === 0 ? '*' : ''}</span><button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('hotel', ${hotel.id})">√ó</button></div>${hotel.notes ? `<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 11px;">üìù ${hotel.notes}</div>` : ''}`; listEl.appendChild(card); }); document.getElementById('hotelCountStat').textContent = tourData.hotels.length; document.getElementById('hotelDaysStat').textContent = Math.round(totalNights); document.getElementById('hotelCostStat').textContent = '$' + totalCAD.toFixed(0); }
    function updateRoutesDisplay() { const container = document.getElementById('routeSteps'); if (!container) return; updateRouteSelects(); }
    function updateExpensesDisplay() { const tbody = document.getElementById('expensesBody'); if (!tbody) return; tbody.innerHTML = ''; let totalCAD = 0; const sortedExpenses = [...tourData.expenses].sort((a, b) => new Date(a.date) - new Date(b.date)); sortedExpenses.forEach(expense => { totalCAD += expense.amountCAD || (expense.amountUSD * 1.35); const row = tbody.insertRow(); const displayCAD = expense.amountCAD > 0 ? expense.amountCAD : (expense.amountUSD * 1.35); row.innerHTML = `<td style="padding: 8px;">${formatDate(expense.date)}</td><td style="padding: 8px;">${expense.type}</td><td style="padding: 8px;">${(expense.location || 'N/A').substring(0, 15)}...</td><td style="padding: 8px;">${expense.amountUSD.toFixed(0)}</td><td style="padding: 8px;">${displayCAD.toFixed(0)}${expense.amountCAD === 0 ? '*' : ''}</td><td style="padding: 8px;"><button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('expense', ${expense.id})">√ó</button></td>`; }); document.getElementById('expenseCountStat').textContent = tourData.expenses.length; document.getElementById('expenseCostStat').textContent = '$' + totalCAD.toFixed(0); }
    function getGasSettings() { return tourData.settings || { kmPerLitre: 8.5, costPerLitre: 1.75, heavyFootPercent: 10 }; }
    function calculateGasCost(distanceKm) { const { kmPerLitre, costPerLitre, heavyFootPercent } = getGasSettings(); if (kmPerLitre <= 0) return 0; const effective = kmPerLitre / (1 + (heavyFootPercent / 100)); return (distanceKm / effective) * costPerLitre; }
    function applySettings() { tourData.settings.kmPerLitre = parseFloat(document.getElementById('kmPerLitre').value) || 8.5; tourData.settings.costPerLitre = parseFloat(document.getElementById('costPerLitre').value) || 1.75; tourData.settings.heavyFootPercent = parseFloat(document.getElementById('heavyFootPercent').value) || 10; saveData(); alert('Settings Saved!'); }
    
    function addHotel() { const usdCost = parseFloat(document.getElementById('hotelCostUSD').value) || 0; const cadCost = parseFloat(document.getElementById('hotelCostCAD').value) || 0; const hotel = { id: Date.now(), name: document.getElementById('hotelName').value || '', address: document.getElementById('hotelAddress').value || '', checkin: document.getElementById('checkinDate').value || '', checkout: document.getElementById('checkoutDate').value || '', costUSD: usdCost, costCAD: cadCost, notes: document.getElementById('hotelNotes').value || '', type: 'hotel' }; if (hotel.name && hotel.address && hotel.checkin) { tourData.hotels.push(hotel); saveData(); updateAllDisplays(); clearForm(['hotelName', 'hotelAddress', 'checkinDate', 'checkoutDate', 'hotelCostUSD', 'hotelCostCAD', 'hotelNotes']); alert('Hotel added!'); } else { alert('Please fill in hotel name, full address, and check-in date'); } }
    function addVenue() { const venue = { id: Date.now(), name: document.getElementById('venueName').value || '', address: document.getElementById('venueAddress').value || '', date: document.getElementById('showDate').value || '', time: document.getElementById('showTime').value || '', startInventory: parseInt(document.getElementById('startInventory').value) || 0, endInventory: parseInt(document.getElementById('endInventory').value) || 0, totalSales: parseFloat(document.getElementById('totalSales').value) || 0, notes: document.getElementById('venueNotes').value || '', type: 'venue' }; if (venue.name && venue.address && venue.date) { tourData.venues.push(venue); saveData(); updateAllDisplays(); clearForm(['venueName', 'venueAddress', 'showDate', 'showTime', 'startInventory', 'endInventory', 'totalSales', 'venueNotes']); alert('Venue added!'); } else { alert('Please fill in venue name, full address, and show date'); } }
    function addExpense() { const usdCost = parseFloat(document.getElementById('expenseAmountUSD').value) || 0; const cadCost = parseFloat(document.getElementById('expenseAmountCAD').value) || 0; const expense = { id: Date.now(), type: document.getElementById('expenseType').value, date: document.getElementById('expenseDate').value, location: document.getElementById('expenseLocation').value, amountUSD: usdCost, amountCAD: cadCost, notes: document.getElementById('expenseNotes').value, category: 'expense' }; if (expense.date && (expense.amountUSD > 0 || expense.amountCAD > 0)) { tourData.expenses.push(expense); saveData(); updateAllDisplays(); clearForm(['expenseAmountUSD', 'expenseAmountCAD', 'expenseLocation', 'expenseNotes']); document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0]; alert('Expense added!'); } else { alert('Please enter date and amount'); } }
    function clearForm(fields) { fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; }); }
    function deleteItem(type, id) { if (confirm(`Delete this ${type}?`)) { if (type === 'hotel') tourData.hotels = tourData.hotels.filter(h => h.id !== id); else if (type === 'venue') tourData.venues = tourData.venues.filter(v => v.id !== id); else if (type === 'expense') tourData.expenses = tourData.expenses.filter(e => e.id !== id); saveData(); updateAllDisplays(); } }
    
    function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString + 'T00:00:00'); return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}`; }
    function formatTime(timeString) { if (!timeString) return ''; let [h, m] = timeString.split(':'); const ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; return `${h}:${m} ${ampm}`; }
    function getEventsForDate(dateStr) { let isVenue = tourData.venues.some(v => v.date === dateStr); let isTravel = tourData.routePlannerState.some(r => r.dateValue === dateStr); return { isVenue, isTravel }; }
    function prevMonth() { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); }
    function nextMonth() { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); }
    function saveRoutePlannerState() { tourData.routePlannerState = Array.from(document.querySelectorAll('.route-step')).map((step, i) => ({ selectValue: step.querySelector('select').value, dateValue: step.querySelector('input[type="date"]').value })); saveData(); }
    function loadRoutePlannerState() { const container = document.getElementById('routeSteps'); if (!container) return; container.innerHTML = ''; routeStopCounter = 0; if (tourData.routePlannerState.length === 0) tourData.routePlannerState.push({selectValue: '', dateValue: ''}); tourData.routePlannerState.forEach(() => addRouteStop(false)); updateAllDisplays(); }
    function addRouteStop(shouldSave = true) { const container = document.getElementById('routeSteps'); const index = routeStopCounter; const step = document.createElement('div'); step.className = 'route-step'; step.id = `routeStep${index}`; step.innerHTML = `<div class="route-step-number">${index + 1}</div><select id="routeSelect${index}" onchange="saveRoutePlannerState()"></select><input type="date" id="routeDate${index}" onchange="saveRoutePlannerState()" style="margin-left: 10px; width: 120px; padding: 4px; font-size: 12px; flex-shrink: 0;">`; container.appendChild(step); routeStopCounter++; if (shouldSave) tourData.routePlannerState.push({selectValue: '', dateValue: ''}); updateAllDisplays(); }
    function removeRouteStop(shouldSave = true) { if (routeStopCounter <= 1) return; const container = document.getElementById('routeSteps'); container.lastElementChild.remove(); routeStopCounter--; if(shouldSave) tourData.routePlannerState.pop(); updateAllDisplays(); }
    function clearAllStops() { tourData.routePlannerState = [{selectValue: '', dateValue: ''}]; tourData.routeCache = {}; loadRoutePlannerState(); document.getElementById('routeResults').innerHTML = ''; saveData(); }
    function autoFillRoute() { if (!confirm('This will replace current route plan with one auto-filled from hotels and venues, sorted by date. Continue?')) return; tourData.routePlannerState = []; const allStops = []; tourData.hotels.forEach(h => { if(h.checkin) allStops.push({ date: h.checkin, stopId: `Hotel:${h.id}`, sortKey: new Date(h.checkin).getTime() }); }); tourData.venues.forEach(v => { if(v.date) allStops.push({ date: v.date, stopId: `Venue:${v.id}`, sortKey: new Date(v.date).getTime() + 1 }); }); allStops.sort((a,b) => a.sortKey - b.sortKey); tourData.routePlannerState = allStops.map(s => ({ selectValue: s.stopId, dateValue: s.date })); if (tourData.routePlannerState.length === 0) tourData.routePlannerState.push({selectValue: '', dateValue: ''}); loadRoutePlannerState(); alert(`Auto-filled ${allStops.length} stops!`); }
    function updateRouteSelects() { const selects = document.querySelectorAll('#routeSteps select'); if (!selects.length) return; const allLocations = [...tourData.hotels.map(h => ({ id: h.id, name: h.name, type: 'Hotel' })), ...tourData.venues.map(v => ({ id: v.id, name: v.name, type: 'Venue' }))]; selects.forEach((select, i) => { const savedVal = tourData.routePlannerState[i]?.selectValue || ''; select.innerHTML = `<option value="">-- Select Stop --</option>`; allLocations.forEach(loc => select.innerHTML += `<option value="${loc.type}:${loc.id}">${loc.type}: ${loc.name}</option>`); select.value = savedVal; }); }
    function toggleRouteBuilder() { document.getElementById('route-builder-content').classList.toggle('collapsed'); document.getElementById('routeBuilderToggleArrow').classList.toggle('collapsed'); }
    
    // All other functions here...
    function showDayDetails(dateStr) {
        const modal = document.getElementById('calendarModal');
        const content = document.getElementById('calendarModalContent');
        
        const venuesOnDay = tourData.venues.filter(v => v.date === dateStr);
        const hotelsOnDay = tourData.hotels.filter(h => dateStr >= h.checkin && dateStr <= h.checkout);
        
        let html = `<div class="modal-header"><button class="modal-nav prev" onclick="showPrevDay()">‚óÑ</button><div>Details for ${formatDate(dateStr)}</div><button class="modal-nav next" onclick="showNextDay()">‚ñ∫</button><span class="close" onclick="closeModal('calendarModal')">√ó</span></div>`;
        
        if (venuesOnDay.length > 0) html += `<h3>üéµ Venues</h3>` + venuesOnDay.map(v => `<div class="route-item">${v.name} @ ${formatTime(v.time)}<br><small>${v.address}</small></div>`).join('');
        if (hotelsOnDay.length > 0) html += `<h3>üè® Hotels</h3>` + hotelsOnDay.map(h => `<div class="route-item">${h.name}<br><small>Check-in: ${formatDate(h.checkin)} | Check-out: ${formatDate(h.checkout)}</small></div>`).join('');
        
        if (venuesOnDay.length === 0 && hotelsOnDay.length === 0) {
            html += `<p style="text-align:center; padding: 20px;">No events scheduled for this day.</p>`;
        }
        
        content.innerHTML = html;
        modal.style.display = 'block';
        currentModalDate = dateStr;
    }

    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    // ...etc

</script>
</body>
</html>