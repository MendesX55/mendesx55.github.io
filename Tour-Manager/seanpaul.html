<!DOCTYPE html>
<html lang="en">
<head>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<link href="icon.png" rel="apple-touch-icon"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Tour Management - Sean Paul × Wiz Khalifa × DaBaby</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            min-height: 100vh;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        .header {
            background: linear-gradient(90deg, #ff6b35, #f7931e, #ffd700);
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.6em;
            font-weight: bold;
            color: #000;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.3);
            margin-bottom: 5px;
        }

        .artist-logos {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }

        .logo-placeholder {
            width: 80px;
            height: 35px;
            background: linear-gradient(45deg, #000, #333);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 9px;
            color: #ffd700;
            border: 1px solid #ffd700;
        }

        .container {
            max-width: 430px;
            margin: 0 auto;
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }

        .tab-navigation {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px 15px 0 0;
            margin: 10px 10px 0 10px;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: #ccc;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            border-bottom: 3px solid #ffd700;
        }

        .tab-content {
            flex: 1;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            margin: 0 10px 10px 10px;
            border-radius: 0 0 15px 15px;
            padding: 15px;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .form-section h3 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1.1em;
            border-bottom: 1px solid rgba(255,215,0,0.3);
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #fff;
            font-weight: bold;
            font-size: 13px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            color: #000;
            font-size: 16px;
            -webkit-appearance: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .currency-input {
            position: relative;
        }

        .currency-prefix {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
        }

        .currency-input input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            height: 42px;
            box-sizing: border-box;
            padding-left: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px 0;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
            width: auto;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            overflow: hidden;
            font-size: 11px;
        }

        .data-table th, .data-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            word-break: break-word;
        }

        .data-table th {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            font-weight: bold;
            font-size: 10px;
        }

        .data-table tr:hover {
            background: rgba(255,255,255,0.1);
        }

        .data-table td:hover {
            background: rgba(255,215,0,0.1);
            cursor: pointer;
        }

        .route-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ffd700;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .route-info {
            font-size: 12px;
            color: #ccc;
            line-height: 1.4;
        }

        .route-controls {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 3px;
        }

        .stat-label {
            color: #ccc;
            font-size: 0.8em;
        }

        .venue-card, .hotel-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ffd700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .venue-card:hover, .hotel-card:hover {
            background: rgba(255,215,0,0.1);
            transform: translateY(-2px);
        }

        .venue-sales {
            background: rgba(0,255,0,0.1);
            border: 1px solid rgba(0,255,0,0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .approx-cad {
            color: #aaa;
            font-size: 11px;
            font-style: italic;
        }

        .manual-cad {
            color: #ffb3ba;
            font-weight: bold;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffd700, transparent);
            margin: 15px 0;
        }

        .summary-box {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .day-summary-box {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .day-summary-box h4 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .modal-header {
            color: #ffd700;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .route-selector {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .route-step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .route-step-number {
            background: #ffd700;
            color: #000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0; 
        }

        .route-step select {
            flex-grow: 1; 
            flex-shrink: 1; 
            min-width: 0; 
            padding: 8px;
            border-radius: 6px;
            border: none;
            background: rgba(255,255,255,0.9);
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Uniform input heights */
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select {
            height: 42px !important;
            font-size: 16px;
            padding: 10px;
            box-sizing: border-box;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .clickable-row:hover {
            background: rgba(255,215,0,0.1) !important;
        }
</style>
</head>
<body>
<div style="padding: 10px 20px;">
<a href="index.html" style="text-decoration: none; color: #ff6b35; font-size: 1.5em;">← Back</a>
</div>
<div class="header">
<h1>🎤 TOUR MANAGER 🎤</h1>
<div class="artist-logos">
<div class="logo-placeholder">SEAN PAUL</div>
<div class="logo-placeholder">WIZ KHALIFA</div>
<div class="logo-placeholder">DABABY</div>
</div>
</div>
<div class="container">
<div class="tab-navigation">
<button class="tab-btn active" onclick="showTab('input')">INPUT</button>
<button class="tab-btn" onclick="showTab('hotels')">HOTELS</button>
<button class="tab-btn" onclick="showTab('expenses')">EXPENSES</button>
<button class="tab-btn" onclick="showTab('routes')">ROUTES</button>
<button class="tab-btn" onclick="showTab('venues')">VENUES</button>
</div>

<!-- INPUT TAB -->
<div class="tab-content active" id="input">
<!-- Hotel Input Section -->
<div class="form-section">
<h3>🏨 Hotel Confirmations</h3>
<div class="form-group">
<label>Hotel Name</label>
<input id="hotelName" placeholder="Hotel name" type="text"/>
</div>
<div class="form-group">
<label>Address</label>
<input id="hotelAddress" placeholder="Full address" type="text"/>
</div>
<div class="form-row">
<div class="form-group">
<label>Check-in</label>
<input id="checkinDate" type="date"/>
</div>
<div class="form-group">
<label>Check-out</label>
<input id="checkoutDate" type="date"/>
</div>
</div>
<div class="form-row-2">
<div class="currency-input">
<label>USD Cost</label>
<span class="currency-prefix">$</span>
<input id="hotelCostUSD" placeholder="0.00" step="0.01" type="number"/>
</div>
<div class="currency-input">
<label>Manual CAD</label>
<span class="currency-prefix">$</span>
<input id="hotelCostCAD" placeholder="0.00" step="0.01" type="number"/>
</div>
</div>
<div class="form-group">
<label>Confirmation Notes</label>
<textarea id="hotelNotes" rows="2" placeholder="Confirmation number, special requests, etc."></textarea>
</div>
<button class="btn" onclick="addHotel()">Add Hotel</button>
</div>

<!-- Venue Input Section -->
<div class="form-section">
<h3>🎵 Venue Information</h3>
<div class="form-group">
<label>Venue Name</label>
<input id="venueName" placeholder="Venue name" type="text"/>
</div>
<div class="form-group">
<label>Address</label>
<input id="venueAddress" placeholder="Full address" type="text"/>
</div>
<div class="form-row">
<div class="form-group">
<label>Show Date</label>
<input id="showDate" type="date"/>
</div>
<div class="form-group">
<label>Show Time</label>
<input id="showTime" type="time"/>
</div>
</div>
<div class="form-row-3">
<div class="form-group">
<label>Start Inventory</label>
<input id="startInventory" placeholder="0" type="number"/>
</div>
<div class="form-group">
<label>End Inventory</label>
<input id="endInventory" placeholder="0" type="number"/>
</div>
<div class="form-group currency-input">
<label>Sales (CAD)</label>
<span class="currency-prefix">$</span>
<input id="totalSales" placeholder="0.00" step="0.01" style="width: 100%;" type="number"/>
</div>
</div>
<div class="form-group">
<label>Venue Notes</label>
<textarea id="venueNotes" rows="2" placeholder="Stage setup, sound requirements, etc."></textarea>
</div>
<button class="btn" onclick="addVenue()">Add Venue</button>
</div>

<!-- Expense Input Section -->
<div class="form-section">
<h3>💰 Expenses</h3>
<div class="form-row">
<div class="form-group">
<label>Type</label>
<select id="expenseType">
<option value="gas">Gas</option>
<option value="food">Food</option>
<option value="tolls">Tolls</option>
<option value="parking">Parking</option>
<option value="misc">Miscellaneous</option>
</select>
</div>
<div class="form-group">
<label>Date</label>
<input id="expenseDate" type="date"/>
</div>
</div>
<div class="form-group">
<label>Location</label>
<input id="expenseLocation" placeholder="Where was this expense?" type="text"/>
</div>
<div class="form-row-2">
<div class="currency-input">
<label>USD Cost</label>
<span class="currency-prefix">$</span>
<input id="expenseAmountUSD" placeholder="0.00" step="0.01" type="number"/>
</div>
<div class="currency-input">
<label>Manual CAD</label>
<span class="currency-prefix">$</span>
<input id="expenseAmountCAD" placeholder="0.00" step="0.01" type="number"/>
</div>
</div>
<div class="form-group">
<label>Notes</label>
<textarea id="expenseNotes" placeholder="Additional notes" rows="2"></textarea>
</div>
<button class="btn" onclick="addExpense()">Add Expense</button>
</div>
</div>

<!-- HOTELS TAB -->
<div class="tab-content" id="hotels">
<div class="summary-box">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="hotelCountStat">0</div>
<div class="stat-label">Total Hotels</div>
</div>
<div class="stat-card">
<div class="stat-value" id="hotelCostStat">$0</div>
<div class="stat-label">Total Cost</div>
</div>
</div>
</div>
<div id="hotelsList"></div>
</div>

<!-- EXPENSES TAB -->
<div class="tab-content" id="expenses">
<div class="summary-box">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="expenseCountStat">0</div>
<div class="stat-label">Total Expenses</div>
</div>
<div class="stat-card">
<div class="stat-value" id="expenseCostStat">$0</div>
<div class="stat-label">Total Cost</div>
</div>
</div>
</div>
<table class="data-table" id="expensesTable">
<thead>
<tr>
<th>Date</th>
<th>Type</th>
<th>Location</th>
<th>USD</th>
<th>CAD</th>
<th>Action</th>
</tr>
</thead>
<tbody id="expensesBody"></tbody>
</table>
</div>

<!-- ROUTES TAB -->
<div class="tab-content" id="routes">
<div class="summary-box">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="totalDistanceStat">0 km</div>
<div class="stat-label">Total Distance</div>
</div>
<div class="stat-card">
<div class="stat-value" id="totalTimeStat">0h</div>
<div class="stat-label">Drive Time</div>
</div>
</div>
</div>

        <div class="route-selector">
<h3 style="color: #ffd700; margin-bottom: 15px;">🗺️ Build Full Tour Itinerary</h3>
<div style="display: flex; gap: 10px; margin-bottom: 15px;">
<button class="btn btn-small" onclick="addRouteStop()">+ Add Stop</button>
<button class="btn btn-small" onclick="removeRouteStop()">- Remove Stop</button>
<button class="btn btn-small" onclick="clearAllStops()">Clear All</button>
<button class="btn btn-small" onclick="autoFillRoute()">Auto-Fill from Hotels/Venues</button>
</div>
<div id="routeSteps">
<div class="route-step">
<div class="route-step-number">1</div>
<select id="routeSelect0" onchange="saveRoutePlannerState()">
<option value="">-- Select Starting Point --</option>
</select>
<input type="date" id="routeDate0" onchange="saveRoutePlannerState()" style="margin-left: 10px; width: 120px; padding: 4px; font-size: 12px; flex-shrink: 0;" placeholder="Date">
</div>
</div>
<button class="btn" onclick="generateCustomRoute()">🛣️ Generate Full Tour Route</button>
<div style="text-align: center; margin-top: 10px;">
<span id="routeStopCount" style="color: #ffd700; font-size: 12px;">Stops: 1 / Unlimited</span>
</div>
</div>

<div id="routeResults"></div>
</div>

<!-- VENUES TAB -->
<div class="tab-content" id="venues">
<div class="summary-box">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="venueCountStat">0</div>
<div class="stat-label">Total Shows</div>
</div>
<div class="stat-card">
<div class="stat-value" id="venueSalesStat">$0</div>
<div class="stat-label">Total Sales</div>
</div>
</div>
</div>
<div id="venuesList"></div>
</div>
</div>

<!-- Hotel Edit Modal -->
<div id="hotelModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeModal('hotelModal')">×</span>
<div>Edit Hotel Details</div>
</div>
<div id="hotelEditForm">
<div class="form-group">
<label>Hotel Name</label>
<input id="editHotelName" type="text"/>
</div>
<div class="form-group">
<label>Address</label>
<input id="editHotelAddress" type="text"/>
</div>
<div class="form-row">
<div class="form-group">
<label>Check-in</label>
<input id="editCheckinDate" type="date"/>
</div>
<div class="form-group">
<label>Check-out</label>
<input id="editCheckoutDate" type="date"/>
</div>
</div>
<div class="form-row-2">
<div class="currency-input">
<label>USD Cost</label>
<span class="currency-prefix">$</span>
<input id="editHotelCostUSD" step="0.01" type="number"/>
</div>
<div class="currency-input">
<label>CAD Cost</label>
<span class="currency-prefix">$</span>
<input id="editHotelCostCAD" step="0.01" type="number"/>
</div>
</div>
<div class="form-group">
<label>Confirmation Notes</label>
<textarea id="editHotelNotes" rows="3" placeholder="Confirmation number, special requests, etc."></textarea>
</div>
<button class="btn" onclick="saveHotelEdit()">Save Changes</button>
<button class="btn btn-danger" onclick="deleteHotel()">Delete Hotel</button>
</div>
</div>
</div>

<!-- Venue Edit Modal -->
<div id="venueModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeModal('venueModal')">×</span>
<div>Edit Venue Details</div>
</div>
<div id="venueEditForm">
<div class="form-group">
<label>Venue Name</label>
<input id="editVenueName" type="text"/>
</div>
<div class="form-group">
<label>Address</label>
<input id="editVenueAddress" type="text"/>
</div>
<div class="form-row">
<div class="form-group">
<label>Show Date</label>
<input id="editShowDate" type="date"/>
</div>
<div class="form-group">
<label>Show Time</label>
<input id="editShowTime" type="time"/>
</div>
</div>
<div class="form-row-3">
<div class="form-group">
<label>Start Inventory</label>
<input id="editStartInventory" type="number"/>
</div>
<div class="form-group">
<label>End Inventory</label>
<input id="editEndInventory" type="number"/>
</div>
<div class="form-group currency-input">
<label>Sales (CAD)</label>
<span class="currency-prefix">$</span>
<input id="editTotalSales" step="0.01" type="number"/>
</div>
</div>
<div class="form-group">
<label>Venue Notes</label>
<textarea id="editVenueNotes" rows="3" placeholder="Stage setup, sound requirements, etc."></textarea>
</div>
<button class="btn" onclick="saveVenueEdit()">Save Changes</button>
<button class="btn btn-danger" onclick="deleteVenue()">Delete Venue</button>
</div>
</div>
</div>

<script>
        // API Key is embedded directly
        const GOOGLE_MAPS_API_KEY = 'AIzaSyDk14v_vZFteu3J3ltcs5jXu03AiVqZUZc';

        // Data storage
        let tourData = {
            hotels: [],
            venues: [],
            expenses: [],
            routePlannerState: [] // NEW: To save the route planner's state
        };

        let currentEditId = null;
        let routeStopCounter = 1;

        // --- NEW HELPER FUNCTIONS FOR DATE/TIME FORMATTING ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00'); // Ensure correct timezone parsing
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}-${month}`;
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            let [hours, minutes] = timeString.split(':');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            return `${hours}:${minutes} ${ampm}`;
        }

        // Load data from localStorage
        window.onload = function() {
            const savedData = localStorage.getItem('tourData');
            if (savedData) {
                tourData = JSON.parse(savedData);
                // Ensure routePlannerState exists for older saves
                if (!tourData.routePlannerState) {
                    tourData.routePlannerState = [];
                }
            }
            loadRoutePlannerState(); // NEW: Load the saved route plan
            updateAllDisplays();
            updateRouteSelects();
            updateStopCounter();
            const today = new Date().toISOString().split('T')[0];
            const expenseDateField = document.getElementById('expenseDate');
            if (expenseDateField) {
                expenseDateField.value = today;
            }
        };

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('tourData', JSON.stringify(tourData));
        }

        // Show tab
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            const targetTab = document.getElementById(tabName);
            if (targetTab) targetTab.classList.add('active');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
            updateAllDisplays();
            updateRouteSelects();
        }

        // Add hotel
        function addHotel() {
            const usdCost = parseFloat(document.getElementById('hotelCostUSD').value) || 0;
            const cadCost = parseFloat(document.getElementById('hotelCostCAD').value) || 0;
            const hotel = {
                id: Date.now(), name: document.getElementById('hotelName').value || '',
                address: document.getElementById('hotelAddress').value || '',
                checkin: document.getElementById('checkinDate').value || '',
                checkout: document.getElementById('checkoutDate').value || '',
                costUSD: usdCost, costCAD: cadCost, approxCAD: usdCost * 1.35,
                notes: document.getElementById('hotelNotes').value || '', type: 'hotel'
            };
            if (hotel.name && hotel.address && hotel.checkin) {
                tourData.hotels.push(hotel);
                saveData();
                updateAllDisplays();
                updateRouteSelects();
                clearHotelForm();
                alert('Hotel added successfully!');
            } else {
                alert('Please fill in hotel name, full address, and check-in date');
            }
        }

        // Add venue
        function addVenue() {
            const venue = {
                id: Date.now(), name: document.getElementById('venueName').value || '',
                address: document.getElementById('venueAddress').value || '',
                date: document.getElementById('showDate').value || '',
                time: document.getElementById('showTime').value || '',
                startInventory: parseInt(document.getElementById('startInventory').value) || 0,
                endInventory: parseInt(document.getElementById('endInventory').value) || 0,
                totalSales: parseFloat(document.getElementById('totalSales').value) || 0,
                notes: document.getElementById('venueNotes').value || '', type: 'venue'
            };
            if (venue.name && venue.address && venue.date) {
                tourData.venues.push(venue);
                saveData();
                updateAllDisplays();
                updateRouteSelects();
                clearVenueForm();
                alert('Venue added successfully!');
            } else {
                alert('Please fill in venue name, full address, and show date');
            }
        }

        // Add expense
        function addExpense() {
            const usdCost = parseFloat(document.getElementById('expenseAmountUSD').value) || 0;
            const cadCost = parseFloat(document.getElementById('expenseAmountCAD').value) || 0;
            const expense = {
                id: Date.now(), type: document.getElementById('expenseType').value,
                date: document.getElementById('expenseDate').value,
                location: document.getElementById('expenseLocation').value,
                amountUSD: usdCost, amountCAD: cadCost, approxCAD: usdCost * 1.35,
                notes: document.getElementById('expenseNotes').value, category: 'expense'
            };
            if (expense.date && (expense.amountUSD > 0 || expense.amountCAD > 0)) {
                tourData.expenses.push(expense);
                saveData();
                updateAllDisplays();
                clearExpenseForm();
                alert('Expense added successfully!');
            } else {
                alert('Please enter date and amount');
            }
        }

        // ---- ROUTE FUNCTIONS ----
        
        // NEW: Saves the current state of the route planner form
        function saveRoutePlannerState() {
            tourData.routePlannerState = [];
            for(let i=0; i<routeStopCounter; i++) {
                const select = document.getElementById(`routeSelect${i}`);
                const date = document.getElementById(`routeDate${i}`);
                if (select && date) {
                    tourData.routePlannerState.push({
                        selectValue: select.value,
                        dateValue: date.value
                    });
                }
            }
            saveData();
        }
        
        // NEW: Loads and rebuilds the route planner form from saved data
        function loadRoutePlannerState() {
            if (!tourData.routePlannerState || tourData.routePlannerState.length === 0) {
                return; // Nothing to load
            }
            const routeStepsContainer = document.getElementById('routeSteps');
            routeStepsContainer.innerHTML = ''; // Clear the default first stop
            
            tourData.routePlannerState.forEach((stop, index) => {
                 const newStep = document.createElement('div');
                 newStep.className = 'route-step';
                 newStep.id = `routeStep${index}`;
                 newStep.innerHTML = `
                    <div class="route-step-number">${index + 1}</div>
                    <select id="routeSelect${index}" onchange="saveRoutePlannerState()"></select>
                    <input type="date" id="routeDate${index}" onchange="saveRoutePlannerState()" style="margin-left: 10px; width: 120px; padding: 4px; font-size: 12px; flex-shrink: 0;">
                `;
                routeStepsContainer.appendChild(newStep);
                document.getElementById(`routeSelect${index}`).value = stop.selectValue;
                document.getElementById(`routeDate${index}`).value = stop.dateValue;
            });
            
            routeStopCounter = tourData.routePlannerState.length;
            updateStopCounter();
            updateRouteSelects();
        }

        function updateStopCounter() {
            const counterElement = document.getElementById('routeStopCount');
            if (counterElement) {
                counterElement.textContent = `Stops: ${routeStopCounter} / Unlimited`;
            }
        }
        
        function addRouteStop() {
            const routeStepsContainer = document.getElementById('routeSteps');
            const newIndex = routeStopCounter;
            const newStep = document.createElement('div');
            newStep.className = 'route-step';
            newStep.id = `routeStep${newIndex}`;
            newStep.innerHTML = `
                <div class="route-step-number">${newIndex + 1}</div>
                <select id="routeSelect${newIndex}" onchange="saveRoutePlannerState()"><option value="">-- Select Next Stop --</option></select>
                <input type="date" id="routeDate${newIndex}" onchange="saveRoutePlannerState()" style="margin-left: 10px; width: 120px; padding: 4px; font-size: 12px; flex-shrink: 0;" placeholder="Date">
            `;
            routeStepsContainer.appendChild(newStep);
            routeStopCounter++;
            updateStopCounter();
            updateRouteSelects();
            saveRoutePlannerState(); // Save after adding
        }

        function removeRouteStop() {
            if (routeStopCounter <= 1) return;
            const routeStepsContainer = document.getElementById('routeSteps');
            const lastStep = routeStepsContainer.lastElementChild;
            if (lastStep && lastStep.id !== 'routeStep0') {
                routeStepsContainer.removeChild(lastStep);
                routeStopCounter--;
                updateStopCounter();
                saveRoutePlannerState(); // Save after removing
            }
        }

        function clearAllStops() {
            const routeStepsContainer = document.getElementById('routeSteps');
            routeStepsContainer.innerHTML = `
                <div class="route-step" id="routeStep0">
                    <div class="route-step-number">1</div>
                    <select id="routeSelect0" onchange="saveRoutePlannerState()"><option value="">-- Select Starting Point --</option></select>
                    <input type="date" id="routeDate0" onchange="saveRoutePlannerState()" style="margin-left: 10px; width: 120px; padding: 4px; font-size: 12px; flex-shrink: 0;">
                </div>`;
            routeStopCounter = 1;
            updateStopCounter();
            updateRouteSelects();
            document.getElementById('routeResults').innerHTML = '';
            saveRoutePlannerState(); // Save after clearing
        }

        function autoFillRoute() {
            alert('Auto-fill functionality is not yet implemented.');
        }

        function updateRouteSelects() {
            const allLocations = [
                ...tourData.hotels.map(h => ({ id: h.id, name: h.name, type: 'Hotel' })),
                ...tourData.venues.map(v => ({ id: v.id, name: v.name, type: 'Venue' }))
            ];
            for (let i = 0; i < routeStopCounter; i++) {
                const select = document.getElementById(`routeSelect${i}`);
                if (select) {
                    const currentValue = select.value;
                    let placeholderText = (i === 0) ? '-- Select Starting Point --' : '-- Select Next Stop --';
                    select.innerHTML = `<option value="">${placeholderText}</option>`;
                    allLocations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = `${location.type}:${location.id}`;
                        option.textContent = `${location.type}: ${location.name}`;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                }
            }
        }

        async function generateCustomRoute() {
            const selectedStops = [];
            for (let i = 0; i < routeStopCounter; i++) {
                const select = document.getElementById(`routeSelect${i}`);
                if (select && select.value) selectedStops.push(select.value);
            }
            if (selectedStops.length < 2) {
                alert('Please select at least 2 stops to create a route.');
                return;
            }

            const routeResults = document.getElementById('routeResults');
            routeResults.innerHTML = '<h3 style="color: #ffd700; margin-bottom: 15px;">🛣️ Generating Real Route...</h3>';

            let grandTotalDistanceKM = 0;
            let grandTotalTimeSecs = 0;
            const dailyRoutes = {};

            try {
                // First pass: Fetch all data and group by day
                for (let i = 0; i < selectedStops.length - 1; i++) {
                    const fromStop = getLocationDetails(selectedStops[i]);
                    const toStop = getLocationDetails(selectedStops[i + 1]);
                    const segmentDate = document.getElementById(`routeDate${i}`).value || 'No Date';

                    const googleApiUrl = `https://maps.googleapis.com/maps/api/directions/json?origin=${encodeURIComponent(fromStop.address)}&destination=${encodeURIComponent(toStop.address)}&departure_time=now&units=metric&key=${GOOGLE_MAPS_API_KEY}`;
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleApiUrl)}`;
                    
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const data = await response.json();
                    if (data.status !== 'OK') throw new Error(`Google Maps API error: ${data.status}. ${data.error_message || ''}`);
                    
                    const leg = data.routes[0].legs[0];
                    const distanceValue = leg.distance.value / 1000;
                    const durationValue = leg.duration_in_traffic.value;

                    if (!dailyRoutes[segmentDate]) {
                        dailyRoutes[segmentDate] = { segments: [], totalDistance: 0, totalTime: 0, totalGas: 0 };
                    }
                    dailyRoutes[segmentDate].segments.push({ fromStop, toStop, leg });
                    dailyRoutes[segmentDate].totalDistance += distanceValue;
                    dailyRoutes[segmentDate].totalTime += durationValue;
                    
                    grandTotalDistanceKM += distanceValue;
                    grandTotalTimeSecs += durationValue;
                }

                // Second pass: Render the grouped data
                routeResults.innerHTML = '<h3 style="color: #ffd700; margin-bottom: 15px;">🛣️ Generated Route</h3>';
                const sortedDates = Object.keys(dailyRoutes).sort();
                let dayCounter = 1;

                for (const date of sortedDates) {
                    const dayData = dailyRoutes[date];
                    const dayHours = Math.floor(dayData.totalTime / 3600);
                    const dayMinutes = Math.floor((dayData.totalTime % 3600) / 60);
                    const dayGasCost = Math.ceil((dayData.totalDistance / 100) * 8.5 * 1.75);

                    const daySummary = document.createElement('div');
                    daySummary.className = 'day-summary-box';
                    daySummary.innerHTML = `
                        <h4>Day ${dayCounter} (${date === 'No Date' ? 'No Date' : formatDate(date)})</h4>
                        <div class="stats-grid">
                            <div class="stat-card"><div class="stat-value">${dayData.totalDistance.toFixed(0)} km</div><div class="stat-label">Day Distance</div></div>
                            <div class="stat-card"><div class="stat-value">${dayHours}h ${dayMinutes}m</div><div class="stat-label">Day Drive Time</div></div>
                        </div>
                    `;
                    routeResults.appendChild(daySummary);
                    
                    dayData.segments.forEach(seg => {
                        const gasCost = Math.ceil(((seg.leg.distance.value / 1000) / 100) * 8.5 * 1.75);
                        const routeSegment = document.createElement('div');
                        routeSegment.className = 'route-item';
                        routeSegment.innerHTML = `
                            <div class="route-header"><strong>${seg.fromStop.name} → ${seg.toStop.name}</strong></div>
                            <div class="route-info">
                                <strong>Distance:</strong> ${seg.leg.distance.text} | <strong>Time (traffic):</strong> ${seg.leg.duration_in_traffic.text}<br>
                                <strong>Est. Gas:</strong> ${gasCost} CAD
                            </div>`;
                        routeResults.appendChild(routeSegment);
                    });
                    dayCounter++;
                }

                const totalHours = Math.floor(grandTotalTimeSecs / 3600);
                const totalMinutes = Math.floor((grandTotalTimeSecs % 3600) / 60);
                document.getElementById('totalDistanceStat').textContent = `${grandTotalDistanceKM.toFixed(0)} km`;
                document.getElementById('totalTimeStat').textContent = `${totalHours}h ${totalMinutes}m`;

            } catch (error) {
                routeResults.innerHTML = `<div class="route-item" style="border-color: #e74c3c;"><strong>Error:</strong> Could not fetch route data. <br><small>${error.message}</small><br><small>This can be a proxy issue or an invalid address. Try again in a moment.</small></div>`;
                console.error("Route generation failed:", error);
            }
        }

        function getLocationDetails(locationId) {
            const [type, id] = locationId.split(':');
            const numId = parseInt(id);
            if (type === 'Hotel') {
                const hotel = tourData.hotels.find(h => h.id === numId);
                return hotel ? { ...hotel } : { type: 'Hotel', name: 'N/A', address: 'N/A' };
            } else {
                const venue = tourData.venues.find(v => v.id === numId);
                return venue ? { ...venue } : { type: 'Venue', name: 'N/A', address: 'N/A' };
            }
        }
        
        // ---- MODAL & DISPLAY FUNCTIONS ----
        function openHotelModal(hotelId) {
            const hotel = tourData.hotels.find(h => h.id === hotelId);
            if (!hotel) return;
            currentEditId = hotelId;
            document.getElementById('editHotelName').value = hotel.name;
            document.getElementById('editHotelAddress').value = hotel.address;
            document.getElementById('editCheckinDate').value = hotel.checkin;
            document.getElementById('editCheckoutDate').value = hotel.checkout;
            document.getElementById('editHotelCostUSD').value = hotel.costUSD;
            document.getElementById('editHotelCostCAD').value = hotel.costCAD;
            document.getElementById('editHotelNotes').value = hotel.notes || '';
            document.getElementById('hotelModal').style.display = 'block';
        }
        function openVenueModal(venueId) {
            const venue = tourData.venues.find(v => v.id === venueId);
            if (!venue) return;
            currentEditId = venueId;
            document.getElementById('editVenueName').value = venue.name;
            document.getElementById('editVenueAddress').value = venue.address;
            document.getElementById('editShowDate').value = venue.date;
            document.getElementById('editShowTime').value = venue.time;
            document.getElementById('editStartInventory').value = venue.startInventory;
            document.getElementById('editEndInventory').value = venue.endInventory;
            document.getElementById('editTotalSales').value = venue.totalSales;
            document.getElementById('editVenueNotes').value = venue.notes || '';
            document.getElementById('venueModal').style.display = 'block';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentEditId = null;
        }
        function saveHotelEdit() {
            const hotel = tourData.hotels.find(h => h.id === currentEditId);
            if (!hotel) return;
            hotel.name = document.getElementById('editHotelName').value;
            hotel.address = document.getElementById('editHotelAddress').value;
            hotel.checkin = document.getElementById('editCheckinDate').value;
            hotel.checkout = document.getElementById('editCheckoutDate').value;
            hotel.costUSD = parseFloat(document.getElementById('editHotelCostUSD').value) || 0;
            hotel.costCAD = parseFloat(document.getElementById('editHotelCostCAD').value) || 0;
            hotel.approxCAD = hotel.costUSD * 1.35;
            hotel.notes = document.getElementById('editHotelNotes').value;
            saveData();
            updateAllDisplays();
            updateRouteSelects();
            closeModal('hotelModal');
        }
        function saveVenueEdit() {
            const venue = tourData.venues.find(v => v.id === currentEditId);
            if (!venue) return;
            venue.name = document.getElementById('editVenueName').value;
            venue.address = document.getElementById('editVenueAddress').value;
            venue.date = document.getElementById('editShowDate').value;
            venue.time = document.getElementById('editShowTime').value;
            venue.startInventory = parseInt(document.getElementById('editStartInventory').value) || 0;
            venue.endInventory = parseInt(document.getElementById('editEndInventory').value) || 0;
            venue.totalSales = parseFloat(document.getElementById('editTotalSales').value) || 0;
            venue.notes = document.getElementById('editVenueNotes').value;
            saveData();
            updateAllDisplays();
            updateRouteSelects();
            closeModal('venueModal');
        }
        function deleteHotel() {
            if (confirm('Are you sure?')) {
                tourData.hotels = tourData.hotels.filter(h => h.id !== currentEditId);
                saveData(); updateAllDisplays(); updateRouteSelects(); closeModal('hotelModal');
            }
        }
        function deleteVenue() {
            if (confirm('Are you sure?')) {
                tourData.venues = tourData.venues.filter(v => v.id !== currentEditId);
                saveData(); updateAllDisplays(); updateRouteSelects(); closeModal('venueModal');
            }
        }
        function updateAllDisplays() {
            updateHotelsDisplay();
            updateExpensesDisplay();
            updateVenuesDisplay();
        }
        function updateHotelsDisplay() {
            const hotelsList = document.getElementById('hotelsList');
            hotelsList.innerHTML = '';
            const sortedHotels = [...tourData.hotels].sort((a, b) => new Date(a.checkin) - new Date(b.checkin));
            let totalCAD = 0;
            sortedHotels.forEach(hotel => {
                totalCAD += hotel.costCAD || hotel.approxCAD;
                const displayCAD = hotel.costCAD > 0 ? hotel.costCAD : hotel.approxCAD;
                const cadClass = hotel.costCAD > 0 ? 'manual-cad' : 'approx-cad';
                const hotelCard = document.createElement('div');
                hotelCard.className = 'hotel-card';
                hotelCard.onclick = () => openHotelModal(hotel.id);
                hotelCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #ffd700;">${hotel.name}</strong>
                        <small style="font-weight: bold; color: #fff;">${formatDate(hotel.checkin)} - ${formatDate(hotel.checkout)}</small>
                    </div>
                    <div style="color: #ccc; font-size: 12px; margin-bottom: 8px;">📍 ${hotel.address.substring(0, 50)}...</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>USD: ${hotel.costUSD.toFixed(0)} | <span class="${cadClass}">CAD: ${displayCAD.toFixed(0)}${hotel.costCAD === 0 ? '*' : ''}</span></span>
                        <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('hotel', ${hotel.id})">×</button>
                    </div>
                    ${hotel.notes ? `<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 11px;">📝 ${hotel.notes}</div>` : ''}
                `;
                hotelsList.appendChild(hotelCard);
            });
            document.getElementById('hotelCountStat').textContent = tourData.hotels.length;
            document.getElementById('hotelCostStat').textContent = '$' + totalCAD.toFixed(0);
        }
        function updateExpensesDisplay() {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';
            let totalCAD = 0;
            const sortedExpenses = [...tourData.expenses].sort((a, b) => new Date(a.date) - new Date(b.date));
            sortedExpenses.forEach(expense => {
                totalCAD += expense.amountCAD || expense.approxCAD;
                const row = tbody.insertRow();
                const displayCAD = expense.amountCAD > 0 ? expense.amountCAD : expense.approxCAD;
                const cadClass = expense.amountCAD > 0 ? 'manual-cad' : 'approx-cad';
                row.innerHTML = `
                    <td>${expense.date}</td><td>${expense.type}</td><td>${(expense.location || 'N/A').substring(0, 15)}...</td>
                    <td>${expense.amountUSD.toFixed(0)}</td><td class="${cadClass}">${displayCAD.toFixed(0)}${expense.amountCAD === 0 ? '*' : ''}</td>
                    <td><button class="btn btn-small btn-danger" onclick="deleteItem('expense', ${expense.id})">×</button></td>`;
            });
            document.getElementById('expenseCountStat').textContent = tourData.expenses.length;
            document.getElementById('expenseCostStat').textContent = '$' + totalCAD.toFixed(0);
        }
        function updateVenuesDisplay() {
            const venuesList = document.getElementById('venuesList');
            venuesList.innerHTML = '';
            const sortedVenues = [...tourData.venues].sort((a, b) => new Date(a.date) - new Date(b.date));
            let totalSales = 0;
            sortedVenues.forEach(venue => {
                totalSales += venue.totalSales;
                const soldItems = venue.startInventory - venue.endInventory;
                const venueCard = document.createElement('div');
                venueCard.className = 'venue-card';
                venueCard.onclick = () => openVenueModal(venue.id);
                venueCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #ffd700;">${venue.name}</strong>
                        <small style="font-weight: bold; color: #fff;">${formatDate(venue.date)} @ ${formatTime(venue.time)}</small>
                    </div>
                    <div style="color: #ccc; font-size: 12px; margin-bottom: 8px;">📍 ${venue.address.substring(0, 50)}...</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px;">Inventory: Start ${venue.startInventory} | End ${venue.endInventory} | Sold ${soldItems}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #4CAF50; font-weight: bold;">Sales: ${venue.totalSales.toLocaleString()} CAD</span>
                        <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteItem('venue', ${venue.id})">×</button>
                    </div>
                    ${venue.notes ? `<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 11px;">📝 ${venue.notes}</div>` : ''}
                `;
                venuesList.appendChild(venueCard);
            });
            document.getElementById('venueCountStat').textContent = tourData.venues.length;
            document.getElementById('venueSalesStat').textContent = '$' + totalSales.toLocaleString();
        }
        function deleteItem(type, id) {
            if (confirm(`Delete this ${type}?`)) {
                if (type === 'hotel') tourData.hotels = tourData.hotels.filter(h => h.id !== id);
                else if (type === 'venue') tourData.venues = tourData.venues.filter(v => v.id !== id);
                else if (type === 'expense') tourData.expenses = tourData.expenses.filter(e => e.id !== id);
                saveData();
                updateAllDisplays();
                updateRouteSelects();
            }
        }
        function clearHotelForm() { ['hotelName', 'hotelAddress', 'checkinDate', 'checkoutDate', 'hotelCostUSD', 'hotelCostCAD', 'hotelNotes'].forEach(id => document.getElementById(id).value = ''); }
        function clearVenueForm() { ['venueName', 'venueAddress', 'showDate', 'showTime', 'startInventory', 'endInventory', 'totalSales', 'venueNotes'].forEach(id => document.getElementById(id).value = ''); }
        function clearExpenseForm() {
            ['expenseAmountUSD', 'expenseAmountCAD', 'expenseLocation', 'expenseNotes'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('hotelCostUSD').addEventListener('input', function() {
                const cadInput = document.getElementById('hotelCostCAD');
                if (this.value && cadInput && !cadInput.value) cadInput.placeholder = `≈ ${(parseFloat(this.value) * 1.35).toFixed(2)} CAD`;
            });
            document.getElementById('expenseAmountUSD').addEventListener('input', function() {
                const cadInput = document.getElementById('expenseAmountCAD');
                if (this.value && cadInput && !cadInput.value) cadInput.placeholder = `≈ ${(parseFloat(this.value) * 1.35).toFixed(2)} CAD`;
            });
        });
        window.onclick = function(event) {
            if (event.target === document.getElementById('hotelModal')) closeModal('hotelModal');
            if (event.target === document.getElementById('venueModal')) closeModal('venueModal');
        }
    </script>
</body>
</html>