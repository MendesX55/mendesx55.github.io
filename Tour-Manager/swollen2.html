<!DOCTYPE html>
<html lang="en">
<head>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<link href="icon.png" rel="apple-touch-icon"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Tour Management - Sean Paul × Wiz Khalifa × DaBaby</title>
<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); background-color: #0f3460; }
        body { font-family: 'Arial', sans-serif; color: #fff; min-height: 100vh; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
        .header { background: linear-gradient(90deg, #ff6b35, #f7931e, #ffd700); padding: 15px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.6em; font-weight: bold; color: #000; text-shadow: 2px 2px 4px rgba(255,255,255,0.3); margin-bottom: 5px; }
        .artist-logos { display: flex; justify-content: center; gap: 10px; margin-top: 8px; }
        .logo-placeholder { width: 80px; height: 35px; background: linear-gradient(45deg, #000, #333); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 9px; color: #ffd700; border: 1px solid #ffd700; }
        .container { max-width: 430px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; flex: 1; min-height: 0; }
        .tab-navigation { display: flex; background: rgba(255,255,255,0.1); border-radius: 15px 15px 0 0; margin: 10px 10px 0 10px; overflow: hidden; }
        .tab-btn { flex: 1; padding: 8px 6px; background: transparent; border: none; color: #ccc; font-weight: bold; font-size: 10px; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; text-align: center; }
        .tab-btn span { font-size: 1.5em; }
        .tab-btn.active { background: rgba(255,215,0,0.2); color: #ffd700; border-bottom: 3px solid #ffd700; }
        .tab-content { flex: 1; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); margin: 0 10px 10px 10px; border-radius: 0 0 15px 15px; padding: 15px; overflow-y: auto; display: none; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .tab-content.active { display: block; }
        .form-section { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .form-section h3 { color: #ffd700; margin-bottom: 12px; font-size: 1.1em; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 5px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; color: #fff; font-weight: bold; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.9); color: #000; font-size: 16px; -webkit-appearance: none; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .currency-input { position: relative; }
        .currency-prefix { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; pointer-events: none; z-index: 1; }
        .currency-input input { padding-left: 30px; }
        .btn { background: linear-gradient(45deg, #ff6b35, #f7931e); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s ease; margin: 5px 0; width: 100%; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: scale(0.98); }
        .btn-small { padding: 6px 12px; font-size: 11px; width: auto; }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .route-item { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #87CEEB; }
        .route-item.show-day { border-left-color: #ff6b35; }
        .route-item.cached { border-left-color: #4CAF50; }
        .route-item.error { border-left-color: #e74c3c; }
        .stats-grid { display: grid; gap: 8px; margin-bottom: 15px; }
        .stats-grid-2-col { grid-template-columns: 1fr 1fr; }
        .stats-grid-3-col { grid-template-columns: 1fr 1fr 1fr; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #ffd700; margin-bottom: 3px; }
        .stat-label { color: #ccc; font-size: 0.8em; }
        .venue-card, .hotel-card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #ffd700; cursor: pointer; transition: all 0.3s ease; }
        .venue-card:hover, .hotel-card:hover { background: rgba(255,215,0,0.1); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
        .card-title { color: #ffd700; font-weight: bold; flex-grow: 1; word-break: break-word; }
        .card-date { font-weight: bold; color: #fff; white-space: nowrap; flex-shrink: 0; font-size: 11px; }
        .summary-box { background: #16213e; border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px; position: sticky; top: -15px; z-index: 10; }
        .day-summary-box { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; padding: 12px; margin-top: 20px; margin-bottom: 10px; }
        .day-summary-box h4 { color: #ffd700; text-align: center; margin-bottom: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); margin: 10% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid rgba(255,215,0,0.3); max-height: 80vh; overflow-y: auto; }
        .modal-header { color: #ffd700; font-size: 1.3em; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #ffd700; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-nav { background: none; border: none; color: #ffd700; font-size: 2em; cursor: pointer; padding: 0 10px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #fff; }
        .route-selector { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .route-selector h3 { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        #route-builder-content.collapsed { display: none; }
        .toggle-arrow { font-size: 1.2em; transition: transform 0.3s ease; }
        .toggle-arrow.collapsed { transform: rotate(-90deg); }
        .route-controls-bottom { display: flex; gap: 10px; margin-top: 15px; margin-bottom: 15px; }
        
        .route-step { display: flex; align-items: center; margin-bottom: 10px; gap: 5px; }
        .route-step-number { background: #ffd700; color: #000; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .route-step-inputs { flex-grow: 1; display: flex; gap: 5px; min-width: 0; }
        .route-step-inputs select { flex-grow: 1; min-width: 0; padding: 8px; border-radius: 6px; border: none; background: rgba(255,255,255,0.9); color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .route-step-inputs input[type="date"] { width: 100px; flex-shrink: 0; padding: 4px; font-size: 12px; }
        .route-control-btn { background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; width: 28px; height: 28px; font-size: 18px; font-weight: bold; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; line-height: 1; padding-bottom: 2px; }
        .route-control-btn.remove { background: rgba(231, 76, 60, 0.4); }

        .progress-bar-container { position: relative; }
        .progress-bar { background: rgba(255,255,255,0.1); border-radius: 10px; height: 20px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 20px; font-size: 11px; font-weight: bold; color: #fff; top: 0; left: 0; }
        input[type="date"], input[type="time"], input[type="number"], select { height: 42px !important; font-size: 16px; padding: 10px; box-sizing: border-box; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .checkbox-item { display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; }
        .checkbox-item input { width: 20px; height: 20px; margin-right: 10px; }
        .settings-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: end; }
        .settings-row .form-group { margin-bottom: 0; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #calendar-header button { background: #ff6b35; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        #month-year { font-size: 1.2em; font-weight: bold; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); min-height: 80px; border-radius: 8px; padding: 5px; font-size: 0.8em; cursor: pointer; transition: background-color 0.3s; }
        .calendar-day:hover { background: rgba(255,215,0,0.2); }
        .calendar-day.other-month { background: rgba(0,0,0,0.1); color: #666; }
        .day-number { font-weight: bold; }
        .day-events { font-size: 1.5em; line-height: 1; margin-top: 5px; }
        .day-note { font-size: 9px; font-style: italic; color: #ccc; margin-top: 5px; }

        .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .currency-input input { width: 100%; min-width: 0; max-width: 100%; box-sizing: border-box; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; color: white; font-size: 1.5em; }

        @media only screen and (max-width: 430px) and (min-device-pixel-ratio: 3) {
            .tab-btn { font-size: 8px; padding: 5px 2px; }
            .tab-btn span { font-size: 1em; }
            .stat-card { padding: 8px; }
            .stat-value { font-size: 1em; }
        }

        html, body {
            height: 100%; overflow: hidden; touch-action: none; overscroll-behavior: none;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
        }
</style>

<style>
/* iPhone 16 Pro Max and iOS 26 scaling/layout fix */
@media only screen and (max-width: 430px) and (min-device-pixel-ratio: 3) {
  .tab-btn { font-size: 8px !important; padding: 4px 2px !important; min-width: 48px !important; }
  .tab-btn span { font-size: 1.2em !important; }
  .stat-card { padding: 8px !important; font-size: 13px !important; max-width: 95px !important; overflow: hidden !important; }
  .stat-value { font-size: 0.95em !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .stat-label { font-size: 0.68em !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .summary-box, .day-summary-box { padding: 8px !important; font-size: 0.97em !important; max-width: 98vw !important; }
  .data-table th, .data-table td { font-size: 0.83em !important; padding: 3px !important; }
  .hotel-card, .venue-card { padding: 9px !important; font-size: 0.95em !important; }
  html, body { font-size: 14px !important; overflow-x: hidden !important; }
}
</style>
</head>
<body style="display: flex; flex-direction: column;">
<div id="loadingOverlay" class="loading-overlay">Connecting & Syncing...</div>
<div id="app-content" style="display: none; flex-direction: column; height: 100%;">
    <div style="padding-top: env(safe-area-inset-top); background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); position: sticky; top: 0; z-index: 999;">
        <a href="index.html" style="display: block; padding: 10px 20px; text-decoration: none; color: #ff6b35; font-size: 1.5em;">← Back</a>
    </div>
    <div class="header">
        <h1>🎤 TOUR MANAGER 🎤</h1>
        <div class="artist-logos">
            <div class="logo-placeholder">SEAN PAUL</div>
            <div class="logo-placeholder">WIZ KHALIFA</div>
            <div class="logo-placeholder">DABABY</div>
        </div>
    </div>
    <div class="container">
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="showTab('calendar')"><span>🗓️</span>CALENDAR</button>
            <button class="tab-btn" onclick="showTab('venues')"><span>🎵</span>VENUES</button>
            <button class="tab-btn" onclick="showTab('hotels')"><span>🏨</span>HOTELS</button>
            <button class="tab-btn" onclick="showTab('routes')"><span>🚗</span>ROUTES</button>
            <button class="tab-btn" onclick="showTab('expenses')"><span>💰</span>EXPENSES</button>
            <button class="tab-btn" onclick="showTab('settings')"><span>⚙️</span>SETTINGS</button>
        </div>
        <!-- TABS CONTENT -->
        <div class="tab-content active" id="calendar">
            <div id="calendar-header">
                <button onclick="prevMonth()">◄ Prev</button>
                <div id="month-year"></div>
                <button onclick="nextMonth()">Next ►</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-weight: bold; color: #ffd700; font-size: 0.8em; padding-bottom: 5px;">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            <div id="calendar-grid"></div>
        </div>
        <div class="tab-content" id="venues">
            <div class="summary-box">
                <div class="stats-grid stats-grid-2-col">
                    <div class="stat-card"><div class="stat-value" id="venueCountStat">0</div><div class="stat-label">Total Shows</div></div>
                    <div class="stat-card"><div class="stat-value" id="venueSalesStat">$0</div><div class="stat-label">Total Sales (USD)</div></div>
                </div>
            </div>
            <div id="venuesList"></div>
        </div>
        <div class="tab-content" id="hotels">
            <div class="summary-box">
                <div class="stats-grid stats-grid-3-col">
                    <div class="stat-card"><div class="stat-value" id="hotelCountStat">0</div><div class="stat-label">Total Hotels</div></div>
                    <div class="stat-card"><div class="stat-value" id="hotelDaysStat">0</div><div class="stat-label">Total Days</div></div>
                    <div class="stat-card"><div class="stat-value" id="hotelCostStat">$0</div><div class="stat-label">Total Cost</div></div>
                </div>
            </div>
            <div id="hotelsList"></div>
        </div>
        <div class="tab-content" id="routes">
            <div class="summary-box">
                <div class="stats-grid stats-grid-3-col">
                    <div class="stat-card"><div class="stat-value" id="totalDistanceStat">0 km</div><div class="stat-label">Total Distance</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalTimeStat">0h</div><div class="stat-label">Drive Time</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalGasStat">$0</div><div class="stat-label">Est. Gas</div></div>
                </div>
            </div>
            <div class="route-selector">
                <h3 onclick="toggleRouteBuilder()">🗺️ Build Full Tour Itinerary <span class="toggle-arrow" id="routeBuilderToggleArrow">▼</span></h3>
                <div id="route-builder-content">
                    <div id="routeSteps"></div>
                    <div class="route-controls-bottom"><button class="btn btn-small" onclick="addRouteStop()">+ Add Stop</button><button class="btn btn-small" onclick="removeRouteStop()">- Remove Last</button><button class="btn btn-small" onclick="clearAllStops()">Clear All</button><button class="btn btn-small" onclick="autoFillRoute()">Auto-Fill</button></div>
                </div>
                <button class="btn" id="generateRouteBtn" onclick="generateCustomRoute()">🛣️ Generate Full Tour Route</button>
                <div class="progress-bar-container" id="routeProgress" style="display: none;">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="progress-text" id="progressText">Preparing...</div>
                </div>
                <div style="text-align: center; margin-top: 10px;"><span id="routeStopCount" style="color: #ffd700; font-size: 12px;">Stops: 0 / Unlimited</span></div>
            </div>
            <div id="routeResults"></div>
        </div>
        <div class="tab-content" id="expenses">
            <div class="summary-box">
                <div class="stats-grid stats-grid-2-col">
                    <div class="stat-card"><div class="stat-value" id="expenseCountStat">0</div><div class="stat-label">Total Expenses</div></div>
                    <div class="stat-card"><div class="stat-value" id="expenseCostStat">$0</div><div class="stat-label">Total Cost</div></div>
                </div>
            </div>
            <table class="data-table" id="expensesTable"><thead><tr><th>Date</th><th>Type</th><th>Location</th><th>USD</th><th>CAD</th><th>Action</th></tr></thead><tbody id="expensesBody"></tbody></table>
        </div>
        <div class="tab-content" id="settings">
            <div class="form-section"><h3>🏨 Hotel Confirmations</h3><div class="form-group"><label>Hotel Name</label><input id="hotelName" placeholder="Hotel name" type="text"/></div><div class="form-group"><label>Address</label><input id="hotelAddress" placeholder="Full address" type="text"/></div><div class="form-row"><div class="form-group"><label>Check-in</label><input id="checkinDate" type="date"/></div><div class="form-group"><label>Check-out</label><input id="checkoutDate" type="date"/></div></div><div class="form-row-2"><div class="form-group currency-input"><label>USD Cost</label><span class="currency-prefix">$</span><input id="hotelCostUSD" placeholder="0.00" step="0.01" type="number"/></div><div class="form-group currency-input"><label>Manual CAD</label><span class="currency-prefix">$</span><input id="hotelCostCAD" placeholder="0.00" step="0.01" type="number"/></div></div><div class="form-group"><label>Confirmation Notes</label><textarea id="hotelNotes" placeholder="Confirmation number, special requests, etc." rows="2"></textarea></div><button class="btn" onclick="addHotel()">Add Hotel</button></div>
            <div class="form-section"><h3>🎵 Venue Information</h3><div class="form-group"><label>Venue Name</label><input id="venueName" placeholder="Venue name" type="text"/></div><div class="form-group"><label>Address</label><input id="venueAddress" placeholder="Full address" type="text"/></div><div class="form-row"><div class="form-group"><label>Show Date</label><input id="showDate" type="date"/></div><div class="form-group"><label>Show Time</label><input id="showTime" type="time"/></div></div><div class="form-row-3"><div class="form-group"><label>Start Inventory</label><input id="startInventory" placeholder="0" type="number"/></div><div class="form-group"><label>End Inventory</label><input id="endInventory" placeholder="0" type="number"/></div><div class="form-group currency-input"><label>Sales (USD)</label><span class="currency-prefix">$</span><input id="totalSales" placeholder="0.00" step="0.01" type="number"/></div></div><div class="form-group"><label>Venue Notes</label><textarea id="venueNotes" placeholder="Stage setup, sound requirements, etc." rows="2"></textarea></div><button class="btn" onclick="addVenue()">Add Venue</button></div>
            <div class="form-section"><h3>💰 Expenses</h3><div class="form-row"><div class="form-group"><label>Type</label><select id="expenseType"><option value="gas">Gas</option><option value="food">Food</option><option value="tolls">Tolls</option><option value="parking">Parking</option><option value="misc">Miscellaneous</option></select></div><div class="form-group"><label>Date</label><input id="expenseDate" type="date"/></div></div><div class="form-group"><label>Location</label><input id="expenseLocation" placeholder="Where was this expense?" type="text"/></div><div class="form-row-2"><div class="form-group currency-input"><label>USD Cost</label><span class="currency-prefix">$</span><input id="expenseAmountUSD" placeholder="0.00" step="0.01" type="number"/></div><div class="form-group currency-input"><label>Manual CAD</label><span class="currency-prefix">$</span><input id="expenseAmountCAD" placeholder="0.00" step="0.01" type="number"/></div></div><div class="form-group"><label>Notes</label><textarea id="expenseNotes" placeholder="Additional notes" rows="2"></textarea></div><button class="btn" onclick="addExpense()">Add Expense</button></div>
            <div class="form-section"><h3>⚙️ App Settings</h3><p style="font-size: 13px; color: #ccc; margin-bottom: 10px;">Configure gas cost calculations.</p>
                <div class="settings-row">
                    <div class="form-group"><label for="litresPer100km">Fuel L/100km</label><input id="litresPer100km" placeholder="e.g. 12" type="number"/></div>
                    <div class="form-group"><label for="costPerLitre">Cost $/L</label><input id="costPerLitre" placeholder="e.g. 1.75" type="number"/></div>
                    <div class="form-group"><label for="heavyFootPercent">Go FAST %</label><input id="heavyFootPercent" placeholder="e.g. 10" type="number"/></div>
                </div>
                <button class="btn" onclick="applySettings()" style="margin-top: 15px;">Apply Settings</button>
            </div>
            <div class="form-section"><h3>📤 Data Management</h3>
                <p style="font-size: 13px; color: #ccc; margin-bottom: 10px;">If data won't save due to size, clear the route cache first.</p>
                <button class="btn btn-danger" onclick="clearRouteCache()">Clear Route Cache & Save</button>
                <p style="font-size: 13px; color: #ccc; margin: 15px 0 10px;">Export a backup of your data.</p>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input checked="" id="exportHotels" type="checkbox"/> Hotels</label>
                    <label class="checkbox-item"><input checked="" id="exportVenues" type="checkbox"/> Venues</label>
                    <label class="checkbox-item"><input checked="" id="exportExpenses" type="checkbox"/> Expenses</label>
                    <label class="checkbox-item"><input id="exportRoute" type="checkbox"/> Full Route Itinerary</label>
                </div>
                <button class="btn" onclick="exportTourData()">Export Selected Data to CSV</button>
                <p id="syncStatus" style="font-size: 12px; text-align: center; color: #ccc; margin-top: 10px;"></p>
            </div>
        </div>
    </div>
</div>
<!-- MODALS -->
<div class="modal" id="hotelModal"><div class="modal-content"><div class="modal-header"><span class="close" onclick="closeModal('hotelModal')">×</span><div>Edit Hotel Details</div></div><div id="hotelEditForm"><div class="form-group"><label>Hotel Name</label><input id="editHotelName" type="text"/></div><div class="form-group"><label>Address</label><input id="editHotelAddress" type="text"/></div><div class="form-row"><div class="form-group"><label>Check-in</label><input id="editCheckinDate" type="date"/></div><div class="form-group"><label>Check-out</label><input id="editCheckoutDate" type="date"/></div></div><div class="form-row-2"><div class="form-group currency-input"><label>USD Cost</label><span class="currency-prefix">$</span><input id="editHotelCostUSD" step="0.01" type="number"/></div><div class="form-group currency-input"><label>CAD Cost</label><span class="currency-prefix">$</span><input id="editHotelCostCAD" step="0.01" type="number"/></div></div><div class="form-group"><label>Confirmation Notes</label><textarea id="editHotelNotes" rows="3"></textarea></div><button class="btn" onclick="saveHotelEdit()">Save Changes</button><button class="btn btn-danger" onclick="deleteHotel()">Delete Hotel</button></div></div></div>
<div class="modal" id="venueModal"><div class="modal-content"><div class="modal-header"><span class="close" onclick="closeModal('venueModal')">×</span><div>Edit Venue Details</div></div><div id="venueEditForm"><div class="form-group"><label>Venue Name</label><input id="editVenueName" type="text"/></div><div class="form-group"><label>Address</label><input id="editVenueAddress" type="text"/></div><div class="form-row"><div class="form-group"><label>Show Date</label><input id="editShowDate" type="date"/></div><div class="form-group"><label>Show Time</label><input id="editShowTime" type="time"/></div></div><div class="form-row-3"><div class="form-group"><label>Start Inventory</label><input id="editStartInventory" type="number"/></div><div class="form-group"><label>End Inventory</label><input id="editEndInventory" type="number"/></div><div class="form-group currency-input"><label>Sales (USD)</label><span class="currency-prefix">$</span><input id="editTotalSales" step="0.01" type="number"/></div></div><div class="form-group"><label>Venue Notes</label><textarea id="editVenueNotes" rows="3"></textarea></div><button class="btn" onclick="saveVenueEdit()">Save Changes</button><button class="btn btn-danger" onclick="deleteVenue()">Delete Venue</button></div></div></div>
<div class="modal" id="calendarModal"><div class="modal-content" id="calendarModalContent"></div></div>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script>
    // --- App Configuration ---
    const TOUR_NAME = "seanpaul";
    const STORAGE_KEY = `tourData_${TOUR_NAME}`; 
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBpv5P-dtJnJMOG3uugWyv70mQdkz5iuCo",
      authDomain: "tour-manager-b2888.firebaseapp.com",
      projectId: "tour-manager-b2888",
    };

    // --- Global State ---
    const defaultData = { 
        hotels: [], venues: [], expenses: [], routePlannerState: [], routeCache: {}, 
        settings: { litresPer100km: 12, costPerLitre: 1.75, heavyFootPercent: 10 },
        lastModified: 0
    };
    let tourData = JSON.parse(JSON.stringify(defaultData));
    let currentEditId = null;
    let isGeneratingRoute = false;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let currentModalDate = null;
    let db, auth;
    let firebaseListener = null;
    let offlineQueue = [];
    let isOnline = navigator.onLine;

    // --- NEW HYBRID DATA MODEL ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeFirebaseAndSync();
    });
    
    function loadFromLocalStorage() {
        const localDataString = localStorage.getItem(STORAGE_KEY);
        if (localDataString) {
            try {
                const localData = JSON.parse(localDataString);
                return { ...defaultData, ...localData };
            } catch (e) {
                console.error("Failed to parse local data.", e);
            }
        }
        return JSON.parse(JSON.stringify(defaultData));
    }

    async function initializeFirebaseAndSync() {
        try {
            updateSyncStatus("Connecting...");
            if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.firestore();
            auth = firebase.auth();
            
            await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            await auth.signInAnonymously();
            
            updateSyncStatus("Syncing...");
            const docRef = db.collection("tourData").doc(STORAGE_KEY);
            
            const localData = loadFromLocalStorage();
            const cloudDoc = await docRef.get();
            const cloudData = cloudDoc.exists() ? cloudDoc.data() : null;

            if (isOnline && cloudData) {
                // Cloud data exists, merge with local data
                tourData = mergeData(cloudData, localData);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(tourData));
                await docRef.set(tourData, { merge: true });
            } else if (localData.lastModified > 0) {
                // No cloud data but local data exists
                tourData = localData;
                if (isOnline) await docRef.set(tourData, { merge: true });
            } else {
                // No local or cloud data, start fresh
                tourData = JSON.parse(JSON.stringify(defaultData));
                if (isOnline) await docRef.set(tourData, { merge: true });
            }

            initializeAppUI();
            if (isOnline) attachLiveListener(docRef);

        } catch (e) {
            console.error("Firebase Auth/Initialization failed:", e);
            updateSyncStatus("⚠️ Cloud Sync Failed");
            tourData = loadFromLocalStorage();
            initializeAppUI();
        }
    }

    function mergeData(cloudData, localData) {
        // Initialize merged data with defaults
        const merged = JSON.parse(JSON.stringify(defaultData));
        
        // Merge arrays to preserve all unique entries
        const arrays = ['hotels', 'venues', 'expenses', 'routePlannerState'];
        arrays.forEach(key => {
            const cloudArray = cloudData[key] || [];
            const localArray = localData[key] || [];
            const combined = [...cloudArray, ...localArray];
            const unique = [];
            const seenIds = new Set();
            combined.forEach(item => {
                if (item.id && !seenIds.has(item.id)) {
                    seenIds.add(item.id);
                    unique.push(item);
                }
            });
            merged[key] = unique;
        });

        // Merge routeCache
        merged.routeCache = cloudData.lastModified > localData.lastModified 
            ? (cloudData.routeCache || {}) 
            : (localData.routeCache || {});

        // Merge settings
        merged.settings = cloudData.lastModified > localData.lastModified 
            ? (cloudData.settings || defaultData.settings) 
            : (localData.settings || defaultData.settings);

        // Set lastModified to the latest timestamp
        merged.lastModified = Math.max(cloudData.lastModified || 0, localData.lastModified || 0);

        return merged;
    }
    
    function attachLiveListener(docRef) {
        if (firebaseListener) firebaseListener(); 
        firebaseListener = docRef.onSnapshot((doc) => {
            if (doc.exists()) {
                const cloudData = doc.data();
                if (cloudData.lastModified > tourData.lastModified) {
                    console.log("Live update is newer. Applying changes.");
                    const localData = loadFromLocalStorage();
                    tourData = mergeData(cloudData, localData);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(tourData));
                    updateAllDisplays();
                    updateSyncStatus(`☁️ Updated: ${new Date().toLocaleTimeString()}`);
                }
            }
        }, (error) => {
            console.error("Error in live listener:", error);
            updateSyncStatus("⚠️ Live Sync Error");
            isOnline = false;
        });
    }

    function initializeAppUI() {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('app-content').style.display = 'flex';
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        updateAllDisplays();
        showTab('calendar');
    }
    
    function saveData(changes = {}) {
        if (!db || !auth.currentUser) {
            offlineQueue.push(changes);
            return Promise.resolve();
        }
        
        Object.assign(tourData, changes, { lastModified: Date.now() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tourData));
        
        if (isOnline) {
            return db.collection("tourData").doc(STORAGE_KEY).set(tourData, { merge: true })
                .then(() => {
                    console.log("Firebase write successful at " + new Date(tourData.lastModified).toLocaleTimeString());
                    updateSyncStatus(`☁️ Synced: ${new Date().toLocaleTimeString()}`);
                    offlineQueue = [];
                })
                .catch((error) => {
                    console.error("Firebase write failed:", error);
                    updateSyncStatus(`⚠️ Save Failed! Error: ${error.code}`);
                    offlineQueue.push(changes);
                    isOnline = false;
                    throw error;
                });
        } else {
            offlineQueue.push(changes);
            return Promise.resolve();
        }
    }

    // Sync offline changes when back online
    window.addEventListener('online', async () => {
        isOnline = true;
        if (!db || !auth.currentUser || offlineQueue.length === 0) return;
        try {
            const docRef = db.collection("tourData").doc(STORAGE_KEY);
            for (const changes of offlineQueue) {
                Object.assign(tourData, changes, { lastModified: Date.now() });
                await docRef.set(tourData, { merge: true });
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tourData));
            offlineQueue = [];
            updateSyncStatus(`☁️ Synced Offline Changes: ${new Date().toLocaleTimeString()}`);
        } catch (error) {
            console.error("Error syncing offline changes:", error);
            updateSyncStatus(`⚠️ Offline Sync Failed: ${error.code}`);
        }
    });

    window.addEventListener('offline', () => {
        isOnline = false;
        updateSyncStatus("⚠️ Offline Mode");
    });
    
    function updateSyncStatus(message) {
        const statusEl = document.getElementById('syncStatus');
        if (statusEl) statusEl.textContent = message;
    }
    
    // Emergency Recovery Function
    function clearRouteCache() {
        if (!confirm("This will clear the route cache to fix size limit errors. You will need to re-generate the route afterwards. Continue?")) {
            return;
        }
        const changes = { routeCache: {} };
        tourData.routeCache = {};
        saveData(changes)
            .then(() => {
                alert("✅ Route cache cleared successfully! You can now save changes. Please re-generate your route.");
                document.getElementById('routeResults').innerHTML = '';
            })
            .catch(e => {
                alert("Failed to clear cache. Error: " + e.message);
            });
    }

    // --- Route Planner & Core App Functions ---
    function renderRouteBuilder() {
        const routeStepsContainer = document.getElementById('routeSteps');
        routeStepsContainer.innerHTML = '';
        if (!tourData.routePlannerState || tourData.routePlannerState.length === 0) {
            tourData.routePlannerState = [{ selectValue: '', dateValue: '' }];
        }
        tourData.routePlannerState.forEach((stopState, index) => {
            const newStep = document.createElement('div');
            newStep.className = 'route-step';
            newStep.id = `routeStep${index}`;
            newStep.innerHTML = `
                <div class="route-step-number">${index + 1}</div>
                <div class="route-step-inputs">
                    <select id="routeSelect${index}" onchange="saveRoutePlannerState()"></select>
                    <input type="date" id="routeDate${index}" onchange="saveRoutePlannerState()">
                </div>
                <button class="route-control-btn" onclick="addStopAfter(${index})">+</button>
                <button class="route-control-btn remove" onclick="removeStopAt(${index})">×</button>
            `;
            routeStepsContainer.appendChild(newStep);
        });
        updateRouteSelects();
        updateStopCounter();
    }
    function addStopAfter(index) {
        saveRoutePlannerState(false); 
        tourData.routePlannerState.splice(index + 1, 0, { selectValue: '', dateValue: '' });
        renderRouteBuilder();
        saveData();
    }
    function removeStopAt(index) {
        if (tourData.routePlannerState.length <= 1) { return; }
        saveRoutePlannerState(false); 
        tourData.routePlannerState.splice(index, 1);
        renderRouteBuilder();
        saveData();
    }
    function addRouteStop() {
        saveRoutePlannerState(false);
        tourData.routePlannerState.push({ selectValue: '', dateValue: '' });
        renderRouteBuilder();
        saveData();
    }
    function removeRouteStop() {
        if (tourData.routePlannerState.length > 1) {
            saveRoutePlannerState(false);
            tourData.routePlannerState.pop();
            renderRouteBuilder();
            saveData();
        }
    }
    function saveRoutePlannerState(andSave = true) {
        let changed = false;
        const newPlannerState = tourData.routePlannerState.map((oldState, index) => {
            const select = document.getElementById(`routeSelect${index}`);
            const date = document.getElementById(`routeDate${index}`);
            const newState = {
                selectValue: select ? select.value : '',
                dateValue: date ? date.value : ''
            };
            if(!oldState || newState.selectValue !== oldState.selectValue || newState.dateValue !== oldState.dateValue) {
                changed = true;
            }
            return newState;
        });
        if (changed) {
            tourData.routePlannerState = newPlannerState;
            if(andSave) {
              saveData();
            }
        }
    }
    function updateStopCounter() { document.getElementById('routeStopCount').textContent = `Stops: ${tourData.routePlannerState.length} / Unlimited`; }
    function updateRouteSelects() {
        const hotels = tourData.hotels.map(h => ({ id: h.id, name: h.name, type: 'Hotel' }));
        const venues = tourData.venues.map(v => ({ id: v.id, name: v.name, type: 'Venue' }));
        tourData.routePlannerState.forEach((savedState, i) => {
            const select = document.getElementById(`routeSelect${i}`);
            if (select) {
                let placeholderText = (i === 0) ? '-- Select Starting Point --' : '-- Select Next Stop --';
                select.innerHTML = `<option value="">${placeholderText}</option>`;
                if (hotels.length > 0) { const hotelGroup = document.createElement('optgroup'); hotelGroup.label = '🏨 Hotels'; hotels.forEach(location => { const option = document.createElement('option'); option.value = `${location.type}:${location.id}`; option.textContent = location.name; hotelGroup.appendChild(option); }); select.appendChild(hotelGroup); }
                if (venues.length > 0) { const venueGroup = document.createElement('optgroup'); venueGroup.label = '🎵 Venues'; venues.forEach(location => { const option = document.createElement('option'); option.value = `${location.type}:${location.id}`; option.textContent = location.name; venueGroup.appendChild(option); }); select.appendChild(venueGroup); }
                select.value = savedState.selectValue; document.getElementById(`routeDate${i}`).value = savedState.dateValue;
            }
        });
    }
    function getGasSettings() {
        const settings = tourData.settings || {};
        const litresPer100km = parseFloat(document.getElementById('litresPer100km').value) || settings.litresPer100km || 12;
        const costPerLitre = parseFloat(document.getElementById('costPerLitre').value) || settings.costPerLitre || 1.75;
        const heavyFootPercent = parseFloat(document.getElementById('heavyFootPercent').value) || settings.heavyFootPercent || 10;
        return { litresPer100km, costPerLitre, heavyFootPercent }; 
    }
    function calculateGasCost(distanceKm) {
        const { litresPer100km, costPerLitre, heavyFootPercent } = getGasSettings();
        if (litresPer100km <= 0) return 0;
        const adjustedLitresPer100km = litresPer100km * (1 + (heavyFootPercent / 100));
        const litresUsed = (distanceKm / 100) * adjustedLitresPer100km;
        return litresUsed * costPerLitre; 
    }
    function applySettings() { 
        const { litresPer100km, costPerLitre, heavyFootPercent } = getGasSettings(); 
        tourData.settings = { litresPer100km, costPerLitre, heavyFootPercent }; 
        saveData({ settings: tourData.settings }); 
        alert("Settings applied and saved."); 
        if (document.getElementById('routeResults').innerHTML.trim() !== '') { rerenderRouteCosts(); } 
    }
    function applySettingsToUI() { 
        const settings = tourData.settings || {}; 
        document.getElementById('litresPer100km').value = settings.litresPer100km || ''; 
        document.getElementById('costPerLitre').value = settings.costPerLitre || ''; 
        document.getElementById('heavyFootPercent').value = settings.heavyFootPercent || ''; 
    }
    function rerenderRouteCosts() { let grandTotalGas = 0; const daySummaries = document.querySelectorAll('#routeResults .day-summary-box'); daySummaries.forEach(daySummary => { let dayTotalDistance = 0; const dayId = daySummary.dataset.dayId; const segments = document.querySelectorAll(`.route-item[data-day-id='${dayId}']`); segments.forEach(segment => { const distanceKm = parseFloat(segment.dataset.distanceKm); dayTotalDistance += distanceKm; const newGasCost = calculateGasCost(distanceKm); segment.querySelector('.gas-cost').textContent = `$${newGasCost.toFixed(0)} CAD`; }); const newDayGasCost = calculateGasCost(dayTotalDistance); grandTotalGas += newDayGasCost; daySummary.querySelector('.day-gas-value').textContent = `$${newDayGasCost.toFixed(0)}`; }); document.getElementById('totalGasStat').textContent = '$' + grandTotalGas.toFixed(0); }
    function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString + 'T00:00:00'); const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); return `${day}-${month}`; }
    function formatTime(timeString) { if (!timeString) return ''; let [hours, minutes] = timeString.split(':'); const ampm = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12 || 12; return `${hours}:${minutes} ${ampm}`; }
    function showTab(tabName) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); document.getElementById(tabName).classList.add('active'); const activeButton = document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`); if (activeButton) activeButton.classList.add('active'); updateAllDisplays(); }
    function addHotel() { saveRoutePlannerState(false); const usdCost = parseFloat(document.getElementById('hotelCostUSD').value) || 0; const cadCost = parseFloat(document.getElementById('hotelCostCAD').value) || 0; const hotel = { id: Date.now(), name: document.getElementById('hotelName').value || '', address: document.getElementById('hotelAddress').value || '', checkin: document.getElementById('checkinDate').value || '', checkout: document.getElementById('checkoutDate').value || '', costUSD: usdCost, costCAD: cadCost, notes: document.getElementById('hotelNotes').value || '', type: 'hotel' }; if (hotel.name && hotel.address && hotel.checkin) { tourData.hotels.push(hotel); saveData({ hotels: tourData.hotels }); clearHotelForm(); alert('Hotel added successfully!'); } else { alert('Please fill in hotel name, full address, and check-in date'); } }
    function addVenue() { saveRoutePlannerState(false); const venue = { id: Date.now(), name: document.getElementById('venueName').value || '', address: document.getElementById('venueAddress').value || '', date: document.getElementById('showDate').value || '', time: document.getElementById('showTime').value || '', startInventory: parseInt(document.getElementById('startInventory').value) || 0, endInventory: parseInt(document.getElementById('endInventory').value) || 0, totalSales: parseFloat(document.getElementById('totalSales').value) || 0, notes: document.getElementById('venueNotes').value || '', type: 'venue' }; if (venue.name && venue.address && venue.date) { tourData.venues.push(venue); saveData({ venues: tourData.venues }); clearVenueForm(); alert('Venue added successfully!'); } else { alert('Please fill in venue name, full address, and show date'); } }
    function addExpense() { saveRoutePlannerState(false); const usdCost = parseFloat(document.getElementById('expenseAmountUSD').value) || 0; const cadCost = parseFloat(document.getElementById('expenseAmountCAD').value) || 0; const expense = { id: Date.now(), type: document.getElementById('expenseType').value, date: document.getElementById('expenseDate').value, location: document.getElementById('expenseLocation').value, amountUSD: usdCost, amountCAD: cadCost, notes: document.getElementById('expenseNotes').value, category: 'expense' }; if (expense.date && (expense.amountUSD > 0 || expense.amountCAD > 0)) { tourData.expenses.push(expense); saveData({ expenses: tourData.expenses }); clearExpenseForm(); alert('Expense added successfully!'); } else { alert('Please enter date and amount'); } }
    function clearAllStops() {  tourData.routePlannerState = [{ selectValue: '', dateValue: '' }]; tourData.routeCache = {}; renderRouteBuilder(); saveData({ routePlannerState: tourData.routePlannerState, routeCache: {} }); document.getElementById('routeResults').innerHTML = ''; }
    function autoFillRoute() { if (!confirm('This will replace your current route plan. Continue?')) return; tourData.routePlannerState = []; const allStops = []; tourData.hotels.forEach(h => { if (h.checkin) allStops.push({ date: h.checkin, stopId: `Hotel:${h.id}`, sortKey: new Date(h.checkin).getTime() }); }); tourData.venues.forEach(v => { if (v.date) allStops.push({ date: v.date, stopId: `Venue:${v.id}`, sortKey: new Date(v.date).getTime() + 1 }); }); allStops.sort((a, b) => a.sortKey - b.sortKey); tourData.routePlannerState = allStops.map(stop => ({ selectValue: stop.stopId, dateValue: stop.date })); if (tourData.routePlannerState.length === 0) tourData.routePlannerState.push({ selectValue: '', dateValue: '' }); renderRouteBuilder(); saveData({ routePlannerState: tourData.routePlannerState }); alert(`Auto-filled ${allStops.length} stops!`); }
    function toggleRouteBuilder() { const content = document.getElementById('route-builder-content'); const arrow = document.getElementById('routeBuilderToggleArrow'); content.classList.toggle('collapsed'); arrow.classList.toggle('collapsed'); }
    async function generateCustomRoute() { saveRoutePlannerState(); if (isGeneratingRoute) { alert('Route generation in progress...'); return; } isGeneratingRoute = true; const generateBtn = document.getElementById('generateRouteBtn'); const progressDiv = document.getElementById('routeProgress'); const progressFill = document.getElementById('progressFill'); const progressText = document.getElementById('progressText'); const routeResults = document.getElementById('routeResults'); generateBtn.disabled = true; generateBtn.textContent = '🔄 Generating...'; progressDiv.style.display = 'block'; routeResults.innerHTML = ''; progressText.textContent = 'Preparing route...'; progressFill.style.width = '0%'; try { const dailySegments = {}; for (let i = 0; i < tourData.routePlannerState.length - 1; i++) { const fromStopInfo = tourData.routePlannerState[i]; const toStopInfo = tourData.routePlannerState[i + 1]; if (!fromStopInfo.selectValue || !toStopInfo.selectValue) continue; const date = fromStopInfo.dateValue || 'No Date'; if (!dailySegments[date]) dailySegments[date] = []; if (dailySegments[date].length === 0) dailySegments[date].push(getLocationDetails(fromStopInfo.selectValue)); dailySegments[date].push(getLocationDetails(toStopInfo.selectValue)); } const allDates = Object.keys(dailySegments).sort(); if (allDates.length === 0) throw new Error('No valid route segments found.'); let grandTotalDistanceMeters = 0, grandTotalTimeSecs = 0, processedDays = 0; routeResults.innerHTML = '<h3 style="color: #ffd700; margin-bottom: 15px;">🛣️ Generated Route</h3>'; for (const date of allDates) { const stopsForDay = dailySegments[date]; try { const dayRouteData = await processDayRoute(date, stopsForDay); grandTotalDistanceMeters += dayRouteData.totalDistance || 0; grandTotalTimeSecs += dayRouteData.totalTime || 0; renderDayRoute(date, dayRouteData, processedDays + 1); } catch (dayError) { renderErrorDay(date, processedDays + 1, dayError.message); } processedDays++; const progress = (processedDays / allDates.length) * 100; progressFill.style.width = `${progress}%`; progressText.textContent = `Day ${processedDays}/${allDates.length} processed...`; await new Promise(resolve => setTimeout(resolve, 300)); } const grandTotalGas = calculateGasCost(grandTotalDistanceMeters / 1000); const totalHours = Math.floor(grandTotalTimeSecs / 3600); const totalMinutes = Math.floor((grandTotalTimeSecs % 3600) / 60); document.getElementById('totalDistanceStat').textContent = `${(grandTotalDistanceMeters/1000).toFixed(0)} km`; document.getElementById('totalTimeStat').textContent = `${totalHours}h ${totalMinutes}m`; document.getElementById('totalGasStat').textContent = '$' + grandTotalGas.toFixed(0); progressText.textContent = '✅ All days completed!'; } catch (error) { console.error('Route generation error:', error); routeResults.innerHTML = `<div class="route-item error"><strong>❌ Error:</strong> ${error.message}</div>`; progressText.textContent = '❌ Generation failed'; } finally { isGeneratingRoute = false; generateBtn.disabled = false; generateBtn.textContent = '🛣️ Generate Full Tour Route'; setTimeout(() => { progressDiv.style.display = 'none'; }, 3000); } }
    async function processDayRoute(date, stopsForDay) { 
        if (stopsForDay.length < 2) throw new Error(`Insufficient stops for ${date}`); 
        const cacheKey = `${date}_${stopsForDay.map(s => s.address).join('|')}`; 
        if (tourData.routeCache[cacheKey] && (Date.now() - tourData.routeCache[cacheKey].timestamp < 86400000)) { // 24hr cache
             let cachedData = tourData.routeCache[cacheKey]; 
             cachedData.isCached = true; 
             return cachedData; 
        } 
        let totalDistanceMeters = 0, totalTimeSecs = 0; 
        let allLegs = []; 
        const MAX_WAYPOINTS = 23; 
        for (let i = 0; i < stopsForDay.length - 1; i += MAX_WAYPOINTS) { 
            const chunk = stopsForDay.slice(i, i + MAX_WAYPOINTS + 1); 
            if (chunk.length < 2) break; 
            const origin = chunk[0].address; 
            const destination = chunk[chunk.length - 1].address; 
            const waypoints = chunk.slice(1, -1).map(s => s.address).join('|'); 
            const url = `https://maps-proxy-hru8.onrender.com/maps?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&waypoints=${encodeURIComponent(waypoints)}`; 
            const response = await fetch(url); 
            if (!response.ok) throw new Error(`API Load failed (status: ${response.status})`); 
            const data = await response.json(); 
            if (data.status !== 'OK') throw new Error(`Google Maps Error: ${data.status}. ${data.error_message || 'Check addresses'}`); 
            const legs = data.routes[0].legs; 
            const processedLegs = legs.map(leg => ({
                distanceText: leg.distance.text,
                durationText: (leg.duration_in_traffic || leg.duration).text,
                distanceValue: leg.distance.value,
                durationValue: (leg.duration_in_traffic || leg.duration).value
            }));
            allLegs.push(...processedLegs); 
            for (let leg of processedLegs) { 
                totalDistanceMeters += leg.distanceValue; 
                totalTimeSecs += leg.durationValue; 
            } 
        } 
        const dayData = { legs: allLegs, stops: stopsForDay, totalDistance: totalDistanceMeters, totalTime: totalTimeSecs, isCached: false }; 
        tourData.routeCache[cacheKey] = { legs: allLegs, totalDistance: totalDistanceMeters, totalTime: totalTimeSecs, stops: stopsForDay, timestamp: Date.now() }; 
        saveData({ routeCache: tourData.routeCache }); 
        return dayData; 
    }
    function renderDayRoute(date, dayData, dayCounter) { const routeResults = document.getElementById('routeResults'); const dayHours = Math.floor(dayData.totalTime / 3600); const dayMinutes = Math.floor((dayData.totalTime % 3600) / 60); const dayDistanceKm = dayData.totalDistance / 1000; const dayGasCost = calculateGasCost(dayDistanceKm); const dayId = `day-${dayCounter}`; const daySummary = document.createElement('div'); daySummary.className = 'day-summary-box'; daySummary.dataset.dayId = dayId; daySummary.innerHTML = `<h4>Day ${dayCounter} (${date === 'No Date' ? 'No Date' : formatDate(date)}) ✅</h4><div class="stats-grid stats-grid-3-col"><div class="stat-card"><div class="stat-value">${dayDistanceKm.toFixed(0)} km</div><div class="stat-label">Day Distance</div></div><div class="stat-card"><div class="stat-value">${dayHours}h ${dayMinutes}m</div><div class="stat-label">Day Drive Time</div></div><div class="stat-card"><div class="stat-value day-gas-value">$${dayGasCost.toFixed(0)}</div><div class="stat-label">Est. Gas</div></div></div>`; routeResults.appendChild(daySummary); dayData.legs.forEach((leg, index) => { const legKm = leg.distanceValue / 1000; const gasCost = calculateGasCost(legKm); const toStop = dayData.stops[index+1]; const routeSegment = document.createElement('div'); routeSegment.className = `route-item ${dayData.isCached ? 'cached' : ''} ${toStop.type === 'Venue' ? 'show-day' : ''}`; routeSegment.dataset.dayId = dayId; routeSegment.dataset.distanceKm = legKm; routeSegment.innerHTML = `<div class="route-header"><strong>${dayData.stops[index].name} → ${toStop.name}</strong><span style="color: ${dayData.isCached ? '#4CAF50' : '#87CEEB'}; font-size: 10px;">✓ ${dayData.isCached ? 'CACHED' : 'REAL-TIME'}</span></div><div class="route-info"><strong>Distance:</strong> ${leg.distanceText} | <strong>Time (traffic):</strong> ${leg.durationText}<br><strong>Est. Gas:</strong> <span class="gas-cost">$${gasCost.toFixed(0)} CAD</span></div>`; routeResults.appendChild(routeSegment); }); }
    function renderErrorDay(date, dayCounter, errorMessage) { const routeResults = document.getElementById('routeResults'); const errorSummary = document.createElement('div'); errorSummary.className = 'day-summary-box'; errorSummary.style.borderColor = '#e74c3c'; errorSummary.innerHTML = `<h4>Day ${dayCounter} (${date === 'No Date' ? 'No Date' : formatDate(date)}) ❌</h4><div class="route-item error"><strong>Error:</strong> ${errorMessage}</div>`; routeResults.appendChild(errorSummary); }
    function renderCalendar() { const calendarEl = document.getElementById('calendar-grid'); const monthYearEl = document.getElementById('month-year'); if (!calendarEl || !monthYearEl) return; calendarEl.innerHTML = ''; const firstDay = new Date(currentYear, currentMonth, 1).getDay(); const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate(); monthYearEl.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`; for (let i = 0; i < firstDay; i++) { calendarEl.innerHTML += `<div class="calendar-day other-month"></div>`; } for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; let dayHtml = `<div class="calendar-day" onclick="showDayDetails('${dateStr}')"><div class="day-number">${day}</div>`; const events = getEventsForDate(dateStr); let eventIcons = ''; if (events.isVenue) { eventIcons += '🎵'; } else if (events.isTravel) { eventIcons += '🚗'; } dayHtml += `<div class="day-events">${eventIcons}</div>`; dayHtml += '</div>'; calendarEl.innerHTML += dayHtml; } }
    function getEventsForDate(dateStr) { let isVenue = tourData.venues.some(v => v.date === dateStr); let isTravel = tourData.routePlannerState.some(r => r.dateValue === dateStr); return { isVenue, isTravel }; }
    function showDayDetails(dateStr) {
    saveRoutePlannerState(false);
    const modal = document.getElementById('calendarModal');
    const content = document.getElementById('calendarModalContent');
    const venuesOnDay = tourData.venues.filter(v => v.date === dateStr);
    const hotelsOnDay = tourData.hotels.filter(h => dateStr >= h.checkin && dateStr <= h.checkout);
    const stopsForDay = [];
    for (let i = 0; i < tourData.routePlannerState.length - 1; i++) {
        if (tourData.routePlannerState[i].dateValue === dateStr) {
            if (stopsForDay.length === 0) stopsForDay.push(getLocationDetails(tourData.routePlannerState[i].selectValue));
            stopsForDay.push(getLocationDetails(tourData.routePlannerState[i + 1].selectValue));
        }
    }
    let html = `<div class="modal-header"><button class="modal-nav prev" onclick="showPrevDay()">◄</button><div>Details for ${formatDate(dateStr)}</div><button class="modal-nav next" onclick="showNextDay()">►</button><span class="close" onclick="closeModal('calendarModal')">×</span></div>`;
    if (venuesOnDay.length > 0) {
        html += `<h3>🎵 Venues</h3>` + venuesOnDay.map(v => `<div class="route-item">${v.name} @ ${formatTime(v.time)}<br><small>${v.address}</small></div>`).join('');
    }
    if (hotelsOnDay.length > 0) {
        html += `<h3>🏨 Hotels</h3>` + hotelsOnDay.map(h => `<div class="route-item">${h.name}<br><small>Check-in: ${formatDate(h.checkin)} | Check-out: ${formatDate(h.checkout)}</small></div>`).join('');
    }
    if (stopsForDay.length > 1) {
        const cacheKey = `${dateStr}_${stopsForDay.map(s => s.address).join('|')}`;
        if (tourData.routeCache[cacheKey]) {
            const dayData = tourData.routeCache[cacheKey];
            const dayHours = Math.floor(dayData.totalTime / 3600);
            const dayMinutes = Math.floor((dayData.totalTime % 3600) / 60);
            const dayGas = calculateGasCost(dayData.totalDistance / 1000);
            html += `<h3>🚗 Travel Summary</h3><div class="day-summary-box" style="margin-top:0;"><div class="stats-grid stats-grid-3-col" style="margin-bottom:0;"><div class="stat-card"><div class="stat-value">${(dayData.totalDistance/1000).toFixed(0)} km</div><div class="stat-label">Distance</div></div><div class="stat-card"><div class="stat-value">${dayHours}h ${dayMinutes}m</div><div class="stat-label">Drive Time</div></div><div class="stat-card"><div class="stat-value">$${dayGas.toFixed(0)}</div><div class="stat-label">Est. Gas</div></div></div></div>`;
        } else {
            html += `<h3>🚗 Travel Summary</h3><div class="route-item error">No route data available for this day. Generate the route to see details.</div>`;
        }
    }
    if (venuesOnDay.length === 0 && hotelsOnDay.length === 0 && stopsForDay.length === 0) {
        html += `<p>No events or travel scheduled for this day.</p>`;
    }
    content.innerHTML = html;
    currentModalDate = dateStr;
    modal.style.display = 'block';
} 
    function showPrevDay() {
    if (!currentModalDate) return;
    const date = new Date(currentModalDate);
    date.setDate(date.getDate() - 1);
    const newDateStr = date.toISOString().split('T')[0];
    showDayDetails(newDateStr);
}

function showNextDay() {
    if (!currentModalDate) return;
    const date = new Date(currentModalDate);
    date.setDate(date.getDate() + 1);
    const newDateStr = date.toISOString().split('T')[0];
    showDayDetails(newDateStr);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    currentEditId = null;
    currentModalDate = null;
}

function getLocationDetails(locationStr) {
    if (!locationStr) return { name: 'Unknown', address: '', type: '' };
    const [type, id] = locationStr.split(':');
    let item = null;
    if (type === 'Hotel') item = tourData.hotels.find(h => h.id === parseInt(id));
    else if (type === 'Venue') item = tourData.venues.find(v => v.id === parseInt(id));
    return item ? { name: item.name, address: item.address, type } : { name: 'Unknown', address: '', type };
}

function openHotelModal(id) {
    const hotel = tourData.hotels.find(h => h.id === id);
    if (!hotel) return;
    currentEditId = id;
    document.getElementById('editHotelName').value = hotel.name;
    document.getElementById('editHotelAddress').value = hotel.address;
    document.getElementById('editCheckinDate').value = hotel.checkin;
    document.getElementById('editCheckoutDate').value = hotel.checkout;
    document.getElementById('editHotelCostUSD').value = hotel.costUSD;
    document.getElementById('editHotelCostCAD').value = hotel.costCAD;
    document.getElementById('editHotelNotes').value = hotel.notes;
    document.getElementById('hotelModal').style.display = 'block';
}

function saveHotelEdit() {
    if (!currentEditId) return;
    const updatedHotel = {
        id: currentEditId,
        name: document.getElementById('editHotelName').value,
        address: document.getElementById('editHotelAddress').value,
        checkin: document.getElementById('editCheckinDate').value,
        checkout: document.getElementById('editCheckoutDate').value,
        costUSD: parseFloat(document.getElementById('editHotelCostUSD').value) || 0,
        costCAD: parseFloat(document.getElementById('editHotelCostCAD').value) || 0,
        notes: document.getElementById('editHotelNotes').value,
        type: 'hotel'
    };
    if (updatedHotel.name && updatedHotel.address && updatedHotel.checkin) {
        const index = tourData.hotels.findIndex(h => h.id === currentEditId);
        if (index !== -1) {
            tourData.hotels[index] = updatedHotel;
            saveData({ hotels: tourData.hotels });
            closeModal('hotelModal');
            alert('Hotel updated successfully!');
        }
    } else {
        alert('Please fill in hotel name, address, and check-in date.');
    }
}

function deleteHotel() {
    if (!currentEditId || !confirm('Are you sure you want to delete this hotel?')) return;
    tourData.hotels = tourData.hotels.filter(h => h.id !== currentEditId);
    saveData({ hotels: tourData.hotels });
    closeModal('hotelModal');
    alert('Hotel deleted successfully!');
}

function openVenueModal(id) {
    const venue = tourData.venues.find(v => v.id === id);
    if (!venue) return;
    currentEditId = id;
    document.getElementById('editVenueName').value = venue.name;
    document.getElementById('editVenueAddress').value = venue.address;
    document.getElementById('editShowDate').value = venue.date;
    document.getElementById('editShowTime').value = venue.time;
    document.getElementById('editStartInventory').value = venue.startInventory;
    document.getElementById('editEndInventory').value = venue.endInventory;
    document.getElementById('editTotalSales').value = venue.totalSales;
    document.getElementById('editVenueNotes').value = venue.notes;
    document.getElementById('venueModal').style.display = 'block';
}

function saveVenueEdit() {
    if (!currentEditId) return;
    const updatedVenue = {
        id: currentEditId,
        name: document.getElementById('editVenueName').value,
        address: document.getElementById('editVenueAddress').value,
        date: document.getElementById('editShowDate').value,
        time: document.getElementById('editShowTime').value,
        startInventory: parseInt(document.getElementById('editStartInventory').value) || 0,
        endInventory: parseInt(document.getElementById('editEndInventory').value) || 0,
        totalSales: parseFloat(document.getElementById('editTotalSales').value) || 0,
        notes: document.getElementById('editVenueNotes').value,
        type: 'venue'
    };
    if (updatedVenue.name && updatedVenue.address && updatedVenue.date) {
        const index = tourData.venues.findIndex(v => v.id === currentEditId);
        if (index !== -1) {
            tourData.venues[index] = updatedVenue;
            saveData({ venues: tourData.venues });
            closeModal('venueModal');
            alert('Venue updated successfully!');
        }
    } else {
        alert('Please fill in venue name, address, and show date.');
    }
}

function deleteVenue() {
    if (!currentEditId || !confirm('Are you sure you want to delete this venue?')) return;
    tourData.venues = tourData.venues.filter(v => v.id !== currentEditId);
    saveData({ venues: tourData.venues });
    closeModal('venueModal');
    alert('Venue deleted successfully!');
}

function prevMonth() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar();
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar();
}

function updateAllDisplays() {
    renderCalendar();
    renderHotels();
    renderVenues();
    renderExpenses();
    renderRouteBuilder();
    applySettingsToUI();
    updateStats();
}

function renderHotels() {
    const hotelsList = document.getElementById('hotelsList');
    hotelsList.innerHTML = '';
    tourData.hotels.forEach(hotel => {
        const days = hotel.checkin && hotel.checkout ? Math.ceil((new Date(hotel.checkout) - new Date(hotel.checkin)) / (1000 * 60 * 60 * 24)) : 0;
        const hotelEl = document.createElement('div');
        hotelEl.className = 'hotel-card';
        hotelEl.onclick = () => openHotelModal(hotel.id);
        hotelEl.innerHTML = `
            <div class="card-header">
                <span class="card-title">${hotel.name}</span>
                <span class="card-date">${formatDate(hotel.checkin)} - ${formatDate(hotel.checkout)}</span>
            </div>
            <div><small>${hotel.address}</small></div>
            <div><strong>Cost:</strong> $${hotel.costUSD.toFixed(2)} USD / $${hotel.costCAD.toFixed(2)} CAD | <strong>Days:</strong> ${days}</div>
            ${hotel.notes ? `<div><strong>Notes:</strong> ${hotel.notes}</div>` : ''}
        `;
        hotelsList.appendChild(hotelEl);
    });
    updateHotelStats();
}

function renderVenues() {
    const venuesList = document.getElementById('venuesList');
    venuesList.innerHTML = '';
    tourData.venues.forEach(venue => {
        const venueEl = document.createElement('div');
        venueEl.className = 'venue-card';
        venueEl.onclick = () => openVenueModal(venue.id);
        venueEl.innerHTML = `
            <div class="card-header">
                <span class="card-title">${venue.name}</span>
                <span class="card-date">${formatDate(venue.date)} @ ${formatTime(venue.time)}</span>
            </div>
            <div><small>${venue.address}</small></div>
            <div><strong>Sales:</strong> $${venue.totalSales.toFixed(2)} | <strong>Inventory:</strong> ${venue.startInventory} → ${venue.endInventory}</div>
            ${venue.notes ? `<div><strong>Notes:</strong> ${venue.notes}</div>` : ''}
        `;
        venuesList.appendChild(venueEl);
    });
    updateVenueStats();
}

function renderExpenses() {
    const expensesBody = document.getElementById('expensesBody');
    expensesBody.innerHTML = '';
    tourData.expenses.forEach(expense => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDate(expense.date)}</td>
            <td>${expense.type.charAt(0).toUpperCase() + expense.type.slice(1)}</td>
            <td>${expense.location}</td>
            <td>$${expense.amountUSD.toFixed(2)}</td>
            <td>$${expense.amountCAD.toFixed(2)}</td>
            <td><button class="btn btn-small btn-danger" onclick="deleteExpense(${expense.id})">Delete</button></td>
        `;
        expensesBody.appendChild(row);
    });
    updateExpenseStats();
}

function deleteExpense(id) {
    if (!confirm('Are you sure you want to delete this expense?')) return;
    tourData.expenses = tourData.expenses.filter(e => e.id !== id);
    saveData({ expenses: tourData.expenses });
    renderExpenses();
}

function updateHotelStats() {
    const hotelCount = tourData.hotels.length;
    const hotelDays = tourData.hotels.reduce((sum, h) => sum + (h.checkin && h.checkout ? Math.ceil((new Date(h.checkout) - new Date(h.checkin)) / (1000 * 60 * 60 * 24)) : 0), 0);
    const hotelCost = tourData.hotels.reduce((sum, h) => sum + (h.costUSD || 0), 0);
    document.getElementById('hotelCountStat').textContent = hotelCount;
    document.getElementById('hotelDaysStat').textContent = hotelDays;
    document.getElementById('hotelCostStat').textContent = `$${hotelCost.toFixed(2)}`;
}

function updateVenueStats() {
    const venueCount = tourData.venues.length;
    const venueSales = tourData.venues.reduce((sum, v) => sum + (v.totalSales || 0), 0);
    document.getElementById('venueCountStat').textContent = venueCount;
    document.getElementById('venueSalesStat').textContent = `$${venueSales.toFixed(2)}`;
}

function updateExpenseStats() {
    const expenseCount = tourData.expenses.length;
    const expenseCost = tourData.expenses.reduce((sum, e) => sum + (e.amountUSD || 0), 0);
    document.getElementById('expenseCountStat').textContent = expenseCount;
    document.getElementById('expenseCostStat').textContent = `$${expenseCost.toFixed(2)}`;
}

function updateStats() {
    updateHotelStats();
    updateVenueStats();
    updateExpenseStats();
}

function clearHotelForm() {
    document.getElementById('hotelName').value = '';
    document.getElementById('hotelAddress').value = '';
    document.getElementById('checkinDate').value = '';
    document.getElementById('checkoutDate').value = '';
    document.getElementById('hotelCostUSD').value = '';
    document.getElementById('hotelCostCAD').value = '';
    document.getElementById('hotelNotes').value = '';
}

function clearVenueForm() {
    document.getElementById('venueName').value = '';
    document.getElementById('venueAddress').value = '';
    document.getElementById('showDate').value = '';
    document.getElementById('showTime').value = '';
    document.getElementById('startInventory').value = '';
    document.getElementById('endInventory').value = '';
    document.getElementById('totalSales').value = '';
    document.getElementById('venueNotes').value = '';
}

function clearExpenseForm() {
    document.getElementById('expenseType').value = 'gas';
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('expenseLocation').value = '';
    document.getElementById('expenseAmountUSD').value = '';
    document.getElementById('expenseAmountCAD').value = '';
    document.getElementById('expenseNotes').value = '';
}

function exportTourData() {
    const exportHotels = document.getElementById('exportHotels').checked;
    const exportVenues = document.getElementById('exportVenues').checked;
    const exportExpenses = document.getElementById('exportExpenses').checked;
    const exportRoute = document.getElementById('exportRoute').checked;

    let csvContent = '';
    if (exportHotels) {
        csvContent += 'Hotels\n';
        csvContent += 'Name,Address,Check-in,Check-out,Cost USD,Cost CAD,Notes\n';
        tourData.hotels.forEach(h => {
            csvContent += `"${h.name.replace(/"/g, '""')}","${h.address.replace(/"/g, '""')}","${h.checkin}","${h.checkout}",${h.costUSD},${h.costCAD},"${h.notes.replace(/"/g, '""')}"\n`;
        });
        csvContent += '\n';
    }
    if (exportVenues) {
        csvContent += 'Venues\n';
        csvContent += 'Name,Address,Date,Time,Start Inventory,End Inventory,Total Sales,Notes\n';
        tourData.venues.forEach(v => {
            csvContent += `"${v.name.replace(/"/g, '""')}","${v.address.replace(/"/g, '""')}","${v.date}","${v.time}",${v.startInventory},${v.endInventory},${v.totalSales},"${v.notes.replace(/"/g, '""')}"\n`;
        });
        csvContent += '\n';
    }
    if (exportExpenses) {
        csvContent += 'Expenses\n';
        csvContent += 'Type,Date,Location,Amount USD,Amount CAD,Notes\n';
        tourData.expenses.forEach(e => {
            csvContent += `"${e.type.replace(/"/g, '""')}","${e.date}","${e.location.replace(/"/g, '""')}",${e.amountUSD},${e.amountCAD},"${e.notes.replace(/"/g, '""')}"\n`;
        });
        csvContent += '\n';
    }
    if (exportRoute && tourData.routePlannerState.length > 0) {
        csvContent += 'Route Plan\n';
        csvContent += 'Stop Number,Location Type,Location Name,Date\n';
        tourData.routePlannerState.forEach((stop, index) => {
            const loc = getLocationDetails(stop.selectValue);
            csvContent += `${index + 1},${loc.type},"${loc.name.replace(/"/g, '""')}","${stop.dateValue}"\n`;
        });
    }

    if (!csvContent) {
        alert('No data selected for export.');
        return;
    }

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tour_data_${TOUR_NAME}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
} 

</script>
</body>
</html>