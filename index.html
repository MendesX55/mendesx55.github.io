<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Run Tracker</title>
        <!-- Makes the web app capable of running in full-screen mode -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Sets the style of the status bar (time, battery, etc.) to blend with your app's header -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Sets the name for the app icon on the home screen -->
    <meta name="apple-mobile-web-app-title" content="Run Tracker">
   
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 10px;
            font-size: 16px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .tabs {
            display: flex;
            background: #34495e;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
        }
        
        .tab.active {
            background: #3498db;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-step {
            display: none;
            min-height: 400px;
        }
        
        .form-step.active {
            display: block;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
        }
        
        .step-dot.active {
            background: #3498db;
        }
        
        .step-dot.completed {
            background: #27ae60;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group.large {
            margin-bottom: 40px;
        }
        
        label {
            display: block;
            margin-bottom: 15px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 18px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 20px;
            background: white;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .btn {
            background: #3498db;
            color: white;
            padding: 20px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .step-navigation {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .step-navigation .btn {
            flex: 1;
        }
        
        .runs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .runs-table th,
        .runs-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .runs-table th {
            background: #34495e;
            color: white;
            font-size: 11px;
        }
        
        .runs-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .runs-table input, .runs-table select {
            padding: 4px;
            font-size: 12px;
            border: 1px solid #ddd;
            width: 100%;
        }
        
        .summary {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .summary-row.total {
            font-weight: bold;
            font-size: 16px;
            border-top: 2px solid #34495e;
            padding-top: 10px;
        }
        
        .cash-payment {
            background: #e8f5e8;
        }
        
        .credit-payment {
            background: #e8f0ff;
        }
        
        .account-payment {
            background: #fff8e8;
        }
        
        .delete-btn, .save-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }
        
        .save-btn {
            background: #27ae60;
        }
        
        .large-text {
            font-size: 24px;
            text-align: center;
            margin: 20px 0;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            font-size: 18px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 25px;
            height: 25px;
            margin-right: 15px;
        }
        
        .checkbox-container:hover {
            background: #f8f9fa;
        }
        
        .number-stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .number-stepper button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #3498db;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .number-stepper span {
            font-size: 32px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .runs-table {
                font-size: 10px;
            }
            
            .runs-table th,
            .runs-table td {
                padding: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Devere Logistics Limousine</h1>
            <h2>Airport Run Tracker</h2>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('add-run')">Add Run</button>
            <button class="tab" onclick="switchTab('view-runs')">View Runs</button>
            <button class="tab" onclick="switchTab('expenses')">Expenses</button>
            <button class="tab" onclick="switchTab('summary')">Summary</button>
        </div>
        
        <!-- Add Run Tab -->
        <div id="add-run" class="tab-content active">
            <div class="step-indicator">
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
            </div>
            
            <!-- Step 1: Customer & Company -->
            <div class="form-step active" id="step1">
                <div class="form-group large">
                    <label>Customer Name:</label>
                    <input type="text" id="customerName" placeholder="Enter customer name">
                </div>
                
                <div class="form-group large">
                    <label>Company:</label>
                    <select id="company" onchange="updateCompanyDefaults()">
                        <option value="">Select Company</option>
                        <option value="360 Insights">360 Insights</option>
                        <option value="Staples">Staples</option>
                        <option value="Ontario Shores">Ontario Shores</option>
                        <option value="OPG">OPG</option>
                        <option value="Expedia">Expedia</option>
                        <option value="Gerdau">Gerdau</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="customCompany" placeholder="Enter company name" style="display:none; margin-top:20px;">
                </div>
                
                <div class="step-navigation">
                    <button type="button" class="btn" onclick="nextStep()">Next</button>
                </div>
            </div>
            
            <!-- Step 2: Vehicle & Passengers -->
            <div class="form-step" id="step2">
                <div class="form-group large">
                    <label>Vehicle Type:</label>
                    <select id="vehicleType">
                        <option value="">Select Vehicle</option>
                        <option value="Sedan">Sedan</option>
                        <option value="SUV">SUV</option>
                        <option value="Transit">Transit</option>
                    </select>
                </div>
                
                <div class="form-group large">
                    <label>Number of Passengers:</label>
                    <div class="number-stepper">
                        <button type="button" onclick="changePassengers(-1)">-</button>
                        <span id="passengerCount">1</span>
                        <button type="button" onclick="changePassengers(1)">+</button>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn" onclick="nextStep()">Next</button>
                </div>
            </div>
            
            <!-- Step 3: Date & Locations -->
            <div class="form-step" id="step3">
                <div class="form-group large">
                    <label>Date:</label>
                    <input type="date" id="runDate">
                </div>
                
                <div class="form-group large">
                    <label>Pick Up Location:</label>
                    <select id="pickupLocation">
                        <option value="">Select Pickup</option>
                        <option value="Pickering">Pickering</option>
                        <option value="Ajax">Ajax</option>
                        <option value="Whitby">Whitby</option>
                        <option value="Brooklin">Brooklin</option>
                        <option value="Oshawa">Oshawa</option>
                        <option value="Courtice">Courtice</option>
                        <option value="Bowmanville">Bowmanville</option>
                        <option value="Newcastle">Newcastle</option>
                        <option value="Airport YYZ">Airport YYZ</option>
                        <option value="Airport BB">Airport BB</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="customPickup" placeholder="Enter pickup location" style="display:none; margin-top:20px;">
                </div>
                
                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn" onclick="nextStep()">Next</button>
                </div>
            </div>
            
            <!-- Step 4: Drop off -->
            <div class="form-step" id="step4">
                <div class="form-group large">
                    <label>Drop Off Location:</label>
                    <select id="dropoffLocation">
                        <option value="">Select Dropoff</option>
                        <option value="Pickering">Pickering</option>
                        <option value="Ajax">Ajax</option>
                        <option value="Whitby">Whitby</option>
                        <option value="Brooklin">Brooklin</option>
                        <option value="Oshawa">Oshawa</option>
                        <option value="Courtice">Courtice</option>
                        <option value="Bowmanville">Bowmanville</option>
                        <option value="Newcastle">Newcastle</option>
                        <option value="Airport YYZ">Airport YYZ</option>
                        <option value="Airport BB">Airport BB</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="customDropoff" placeholder="Enter dropoff location" style="display:none; margin-top:20px;">
                </div>
                
                <div class="large-text" id="autoRate" style="color: #27ae60;">
                    Rate will be calculated automatically
                </div>
                
                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn" onclick="nextStep()">Next</button>
                </div>
            </div>
            
            <!-- Step 5: Options -->
            <div class="form-step" id="step5">
                <div class="form-group large">
                    <label>Select Options:</label>
                    
                    <div class="checkbox-container" onclick="toggleCheckbox('use407')">
                        <input type="checkbox" id="use407">
                        <span>Use 407 Highway</span>
                    </div>
                    
                    <div id="toll407Options" style="display:none; margin-top:20px;">
                        <select id="toll407" style="font-size: 18px; padding: 15px;">
                            <option value="18">404 and Pickering - $18</option>
                            <option value="30">427 and Markham - $30</option>
                            <option value="37">427 and Pickering - $37</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-container" onclick="toggleCheckbox('hasWaiting')">
                        <input type="checkbox" id="hasWaiting">
                        <span>Waiting Time</span>
                    </div>
                    
                    <div id="waitingTimeGroup" style="display:none; margin-top:20px;">
                        <label>Waiting Time (30min increments):</label>
                        <div class="number-stepper">
                            <button type="button" onclick="changeWaiting(-1)">-</button>
                            <span id="waitingCount">1</span>
                            <button type="button" onclick="changeWaiting(1)">+</button>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn" onclick="nextStep()">Next</button>
                </div>
            </div>
            
            <!-- Step 6: Payment -->
            <div class="form-step" id="step6">
                <div class="form-group large">
                    <label>Payment Method:</label>
                    <select id="paymentMethod">
                        <option value="">Select Payment</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="On Account">On Account</option>
                    </select>
                </div>
                
                <div class="form-group large">
                    <label>Gratuity Override (leave blank for auto):</label>
                    <input type="number" id="gratuityOverride" step="0.01" placeholder="Auto-calculated">
                </div>
                
                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn" onclick="nextStep()">Review</button>
                </div>
            </div>
            
            <!-- Step 7: Review -->
            <div class="form-step" id="step7">
                <div class="form-group">
                    <label>Review Your Run:</label>
                    <div id="reviewContent" style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-size: 16px;">
                        <!-- Review content will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn btn-success" onclick="submitRun()">Add Run</button>
                </div>
            </div>
        </div>
        
        <!-- View Runs Tab -->
        <div id="view-runs" class="tab-content">
            <div style="margin-bottom: 15px;">
                <label>Filter by Week:</label>
                <input type="week" id="weekFilter" onchange="filterRunsByWeek()">
                <button class="btn btn-warning" onclick="clearWeekFilter()">Show All</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="runs-table" id="runsTable">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Company</th>
                            <th>Vehicle</th>
                            <th>Passengers</th>
                            <th>Date</th>
                            <th>Pickup</th>
                            <th>Dropoff</th>
                            <th>Rate</th>
                            <th>407</th>
                            <th>Airport Fee</th>
                            <th>Waiting</th>
                            <th>Payment</th>
                            <th>Gratuity</th>
                            <th>Total</th>
                            <th>My Cut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="runsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <form id="expenseForm">
                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" id="expenseDate" required>
                </div>
                
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Gas" required>
                </div>
                
                <div class="form-group">
                    <label>Amount:</label>
                    <input type="number" id="expenseAmount" step="0.01" required>
                </div>
                
                <button type="submit" class="btn">Add Expense</button>
            </form>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="runs-table" id="expensesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div style="margin-bottom: 15px;">
                <label>Summary for Week:</label>
                <input type="week" id="summaryWeekFilter" onchange="updateSummary()">
                <button class="btn btn-warning" onclick="clearSummaryFilter()">Show All Time</button>
            </div>
            
            <div class="summary" id="summaryContent">
                <!-- Summary will be populated by JavaScript -->
            </div>
            
            <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
        </div>
    </div>

    <script>
        let runs = JSON.parse(localStorage.getItem('airportRuns')) || [];
        let expenses = JSON.parse(localStorage.getItem('airportExpenses')) || [];
        let currentStep = 1;
        
        const rates = {
            'Sedan': {
                'Pickering': 115, 'Ajax': 115, 'Whitby': 125, 'Brooklin': 130,
                'Oshawa': 130, 'Courtice': 135, 'Bowmanville': 145, 'Newcastle': 160
            },
            'SUV': {
                'Pickering': 140, 'Ajax': 140, 'Whitby': 150, 'Brooklin': 160,
                'Oshawa': 160, 'Courtice': 165, 'Bowmanville': 175, 'Newcastle': 200
            },
            'Transit': {
                'Pickering': 175, 'Ajax': 175, 'Whitby': 200, 'Brooklin': 200,
                'Oshawa': 225, 'Courtice': 225, 'Bowmanville': 250, 'Newcastle': 275
            }
        };
        
        const companyDefaults = {
            '360 Insights': { payment: 'On Account', tipPercent: 10 },
            'Staples': { 
                payment: 'Cash', 
                tipGoing: 10, 
                tipReturn: 15, 
                customRate: 150,
                custom407: 40,
                isCustom: true 
            },
            'Ontario Shores': { payment: 'On Account', tipPercent: 15 },
            'OPG': { payment: 'Credit Card', tipPercent: 15 },
            'Expedia': { payment: 'Credit Card', tipPercent: 0 },
            'Gerdau': { payment: 'On Account', tipPercent: 15 }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('runDate').valueAsDate = new Date();
            document.getElementById('expenseDate').valueAsDate = new Date();
            updateRunsTable();
            updateExpensesTable();
            updateSummary();

            // BUG FIX 2: Listen for changes that affect the rate calculation
            document.getElementById('vehicleType').addEventListener('change', updateRateDisplay);
            document.getElementById('customPickup').addEventListener('input', updateRateDisplay);
            document.getElementById('customDropoff').addEventListener('input', updateRateDisplay);
        });
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'add-run') {
                resetForm();
            }
        }
        
        function nextStep() {
            if (validateCurrentStep()) {
                currentStep++;
                showStep(currentStep);
                updateStepIndicator();
                
                if (currentStep === 7) {
                    populateReview();
                }
            }
        }
        
        function prevStep() {
            currentStep--;
            showStep(currentStep);
            updateStepIndicator();
        }
        
        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }
        
        function updateStepIndicator() {
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    dot.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    dot.classList.add('active');
                }
            });
        }
        
        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    const customerName = document.getElementById('customerName').value.trim();
                    const company = document.getElementById('company').value;
                    const customCompany = document.getElementById('customCompany').value.trim();
                    
                    if (!customerName) {
                        alert('Please enter customer name');
                        return false;
                    }
                    // BUG FIX 1: Removed mandatory company check.
                    if (company === 'Other' && !customCompany) {
                        alert('Please enter company name');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (!document.getElementById('vehicleType').value) {
                        alert('Please select vehicle type');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const pickupLocation = document.getElementById('pickupLocation').value;
                    const customPickup = document.getElementById('customPickup').value.trim();
                    
                    if (!pickupLocation) {
                        alert('Please select pickup location');
                        return false;
                    }
                    if (pickupLocation === 'Other' && !customPickup) {
                        alert('Please enter pickup location');
                        return false;
                    }
                    return true;
                    
                case 4:
                    const dropoffLocation = document.getElementById('dropoffLocation').value;
                    const customDropoff = document.getElementById('customDropoff').value.trim();
                    
                    if (!dropoffLocation) {
                        alert('Please select dropoff location');
                        return false;
                    }
                    if (dropoffLocation === 'Other' && !customDropoff) {
                        alert('Please enter dropoff location');
                        return false;
                    }
                    
                    // BUG FIX 2: Removed stale rate calculation call from here.
                    return true;
                    
                case 5:
                case 6:
                    return true;
                    
                default:
                    return true;
            }
        }
        
        function resetForm() {
            currentStep = 1;
            showStep(1);
            updateStepIndicator();
            
            document.getElementById('customerName').value = '';
            document.getElementById('company').value = '';
            document.getElementById('customCompany').style.display = 'none';
            document.getElementById('vehicleType').value = '';
            document.getElementById('passengerCount').textContent = '1';
            document.getElementById('runDate').valueAsDate = new Date();
            document.getElementById('pickupLocation').value = '';
            document.getElementById('customPickup').style.display = 'none';
            document.getElementById('dropoffLocation').value = '';
            document.getElementById('customDropoff').style.display = 'none';
            document.getElementById('use407').checked = false;
            document.getElementById('toll407Options').style.display = 'none';
            document.getElementById('hasWaiting').checked = false;
            document.getElementById('waitingTimeGroup').style.display = 'none';
            document.getElementById('waitingCount').textContent = '1';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('gratuityOverride').value = '';
            
            // RESET the rate display
            document.getElementById('autoRate').innerHTML = 'Rate will be calculated automatically';
            document.getElementById('autoRate').style.color = '#27ae60';
        }
        
        function updateCompanyDefaults() {
            const company = document.getElementById('company').value;
            const customCompanyInput = document.getElementById('customCompany');
            
            if (company === 'Other') {
                customCompanyInput.style.display = 'block';
            } else {
                customCompanyInput.style.display = 'none';
            }
        }
        
        document.getElementById('pickupLocation').addEventListener('change', function() {
            const customPickup = document.getElementById('customPickup');
            if (this.value === 'Other') {
                customPickup.style.display = 'block';
            } else {
                customPickup.style.display = 'none';
            }
            // BUG FIX 2: Call rate update on change
            updateRateDisplay();
        });
        
        document.getElementById('dropoffLocation').addEventListener('change', function() {
            const customDropoff = document.getElementById('customDropoff');
            if (this.value === 'Other') {
                customDropoff.style.display = 'block';
            } else {
                customDropoff.style.display = 'none';
            }
            // BUG FIX 2: Call rate update on change
            updateRateDisplay();
        });
        
        function changePassengers(delta) {
            const current = parseInt(document.getElementById('passengerCount').textContent);
            const newValue = Math.max(1, current + delta);
            document.getElementById('passengerCount').textContent = newValue;
        }
        
        function changeWaiting(delta) {
            const current = parseInt(document.getElementById('waitingCount').textContent);
            const newValue = Math.max(1, current + delta);
            document.getElementById('waitingCount').textContent = newValue;
        }
        
        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            
            if (id === 'use407') {
                const options = document.getElementById('toll407Options');
                const company = document.getElementById('company').value;
                
                if (checkbox.checked) {
                    options.style.display = 'block';
                    // Set Staples custom 407 rate if applicable
                    if (company === 'Staples' && companyDefaults['Staples'].isCustom) {
                        document.getElementById('toll407').value = companyDefaults['Staples'].custom407;
                    } else {
                        document.getElementById('toll407').value = '37';
                    }
                } else {
                    options.style.display = 'none';
                }
            } else if (id === 'hasWaiting') {
                const group = document.getElementById('waitingTimeGroup');
                if (checkbox.checked) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            }
        }
        
        function updateRateDisplay() {
            const vehicleType = document.getElementById('vehicleType').value;
            const pickup = document.getElementById('pickupLocation').value === 'Other' ?
                document.getElementById('customPickup').value : document.getElementById('pickupLocation').value;
            const dropoff = document.getElementById('dropoffLocation').value === 'Other' ?
                document.getElementById('customDropoff').value : document.getElementById('dropoffLocation').value;
            
            if (vehicleType && pickup && dropoff) {
                let rate = 0;
                
                const isAirportRun = pickup.includes('Airport') || dropoff.includes('Airport');
                
                if (isAirportRun) {
                    const city = pickup.includes('Airport') ? dropoff : pickup;
                    if (rates[vehicleType] && rates[vehicleType][city]) {
                        rate = rates[vehicleType][city];
                    }
                }
                
                if (rate > 0) {
                    document.getElementById('autoRate').innerHTML = `<strong>Base Rate: ${rate}</strong>`;
                    document.getElementById('autoRate').style.color = '#27ae60';
                } else {
                    document.getElementById('autoRate').innerHTML = 'Custom rate - will be entered manually';
                    document.getElementById('autoRate').style.color = '#f39c12';
                }
            }
        }
        
        function calculateRunTotals(runData) {
            const vehicleType = runData.vehicleType;
            const pickup = runData.pickup;
            const dropoff = runData.dropoff;
            const passengers = runData.passengers;
            const company = runData.company;
            const use407 = runData.use407;
            const toll407Amount = runData.toll407Amount || 0;
            const waitingIncrements = runData.waitingIncrements || 0;
            const gratuityOverride = runData.gratuityOverride;
            const baseRateOverride = runData.baseRateOverride;
            
            // Calculate base rate - Check for Staples custom rate first
            let baseRate = 0;
            if (baseRateOverride !== undefined && baseRateOverride !== null) {
                baseRate = parseFloat(baseRateOverride);
            } else if (company === 'Staples' && companyDefaults['Staples'].isCustom) {
                baseRate = companyDefaults['Staples'].customRate;
            } else {
                const isAirportRun = pickup.includes('Airport') || dropoff.includes('Airport');
                if (isAirportRun) {
                    const city = pickup.includes('Airport') ? dropoff : pickup;
                    if (rates[vehicleType] && rates[vehicleType][city]) {
                        baseRate = rates[vehicleType][city];
                    }
                }
            }
            
            // Calculate airport fee - No fee for Airport BB
            let airportFee = 0;
            const isFromAirport = pickup.includes('Airport');
            if (isFromAirport && !pickup.includes('Airport BB')) {
                airportFee = passengers >= 6 ? 27 : 15;
            }
            
            const waitingFee = waitingIncrements * 25;
            
            // Calculate 407 toll - Use Staples custom rate if applicable
            let finalToll407 = toll407Amount;
            if (use407 && company === 'Staples' && companyDefaults['Staples'].isCustom) {
                finalToll407 = companyDefaults['Staples'].custom407;
            }
            
            // Calculate gratuity
            let gratuity = 0;
            if (gratuityOverride !== undefined && gratuityOverride !== null && gratuityOverride !== '') {
                gratuity = parseFloat(gratuityOverride);
            } else if (companyDefaults[company]) {
                if (company === 'Staples') {
                    gratuity = pickup.includes('Airport') ? 15 : 10;
                } else if (companyDefaults[company].tipPercent) {
                    gratuity = (baseRate + waitingFee) * companyDefaults[company].tipPercent / 100;
                }
            }
            
            const totalAmount = baseRate + airportFee + finalToll407 + waitingFee + gratuity;
            const myCommission = (baseRate + waitingFee) * 0.4 + gratuity;
            
            return {
                baseRate,
                airportFee,
                toll407Amount: finalToll407,
                waitingFee,
                gratuity,
                totalAmount,
                myCommission
            };
        }
        
        function populateReview() {
            const company = document.getElementById('company').value === 'Other' ? 
                document.getElementById('customCompany').value : document.getElementById('company').value;
            const pickup = document.getElementById('pickupLocation').value === 'Other' ?
                document.getElementById('customPickup').value : document.getElementById('pickupLocation').value;
            const dropoff = document.getElementById('dropoffLocation').value === 'Other' ?
                document.getElementById('customDropoff').value : document.getElementById('dropoffLocation').value;
            
            const runData = {
                customerName: document.getElementById('customerName').value,
                company: company,
                vehicleType: document.getElementById('vehicleType').value,
                passengers: parseInt(document.getElementById('passengerCount').textContent),
                date: document.getElementById('runDate').value,
                pickup: pickup,
                dropoff: dropoff,
                use407: document.getElementById('use407').checked,
                toll407Amount: document.getElementById('use407').checked ? 
                    parseFloat(document.getElementById('toll407').value) : 0,
                waitingIncrements: document.getElementById('hasWaiting').checked ? 
                    parseInt(document.getElementById('waitingCount').textContent) : 0,
                gratuityOverride: document.getElementById('gratuityOverride').value
            };
            
            if (!document.getElementById('paymentMethod').value && companyDefaults[company]) {
                document.getElementById('paymentMethod').value = companyDefaults[company].payment;
            }
            
            const totals = calculateRunTotals(runData);
            
            const reviewContent = `
                <div style="margin-bottom: 15px;"><strong>Customer:</strong> ${runData.customerName}</div>
                <div style="margin-bottom: 15px;"><strong>Company:</strong> ${runData.company}</div>
                <div style="margin-bottom: 15px;"><strong>Vehicle:</strong> ${runData.vehicleType} (${runData.passengers} passengers)</div>
                <div style="margin-bottom: 15px;"><strong>Date:</strong> ${runData.date}</div>
                <div style="margin-bottom: 15px;"><strong>Route:</strong> ${runData.pickup} → ${runData.dropoff}</div>
                <div style="margin-bottom: 15px;"><strong>Base Rate:</strong> ${totals.baseRate.toFixed(2)}</div>
                ${totals.airportFee > 0 ? `<div style="margin-bottom: 15px;"><strong>Airport Fee:</strong> ${totals.airportFee.toFixed(2)}</div>` : ''}
                ${runData.use407 ? `<div style="margin-bottom: 15px;"><strong>407 Toll:</strong> ${totals.toll407Amount.toFixed(2)}</div>` : ''}
                ${runData.waitingIncrements > 0 ? `<div style="margin-bottom: 15px;"><strong>Waiting Fee:</strong> ${totals.waitingFee.toFixed(2)} (${runData.waitingIncrements} × 30min)</div>` : ''}
                <div style="margin-bottom: 15px;"><strong>Gratuity:</strong> ${totals.gratuity.toFixed(2)}</div>
                <div style="margin-bottom: 15px;"><strong>Payment:</strong> ${document.getElementById('paymentMethod').value}</div>
                <div style="margin-bottom: 15px; font-size: 18px; color: #2c3e50;"><strong>Total Amount: ${totals.totalAmount.toFixed(2)}</strong></div>
                <div style="font-size: 18px; color: #27ae60;"><strong>My Commission: ${totals.myCommission.toFixed(2)}</strong></div>
            `;
            
            document.getElementById('reviewContent').innerHTML = reviewContent;
        }
        
        function submitRun() {
            // Validate payment method is selected
            if (!document.getElementById('paymentMethod').value) {
                alert('Please select a payment method');
                return;
            }
            
            const company = document.getElementById('company').value === 'Other' ? 
                document.getElementById('customCompany').value : document.getElementById('company').value;
            const pickup = document.getElementById('pickupLocation').value === 'Other' ?
                document.getElementById('customPickup').value : document.getElementById('pickupLocation').value;
            const dropoff = document.getElementById('dropoffLocation').value === 'Other' ?
                document.getElementById('customDropoff').value : document.getElementById('dropoffLocation').value;
            
            console.log('Submitting run data:', {
                customerName: document.getElementById('customerName').value,
                company: company,
                vehicleType: document.getElementById('vehicleType').value,
                passengers: parseInt(document.getElementById('passengerCount').textContent),
                date: document.getElementById('runDate').value,
                pickup: pickup,
                dropoff: dropoff,
                paymentMethod: document.getElementById('paymentMethod').value
            });
            
            const runData = {
                customerName: document.getElementById('customerName').value.trim(),
                company: company,
                vehicleType: document.getElementById('vehicleType').value,
                passengers: parseInt(document.getElementById('passengerCount').textContent),
                date: document.getElementById('runDate').value,
                pickup: pickup,
                dropoff: dropoff,
                use407: document.getElementById('use407').checked,
                toll407Amount: document.getElementById('use407').checked ? 
                    parseFloat(document.getElementById('toll407').value) : 0,
                waitingIncrements: document.getElementById('hasWaiting').checked ? 
                    parseInt(document.getElementById('waitingCount').textContent) : 0,
                gratuityOverride: document.getElementById('gratuityOverride').value.trim() !== '' ? 
                    parseFloat(document.getElementById('gratuityOverride').value) : null,
                paymentMethod: document.getElementById('paymentMethod').value
            };
            
            // Final validation
            if (!runData.customerName || !runData.vehicleType || 
                !runData.date || !runData.pickup || !runData.dropoff || !runData.paymentMethod) {
                alert('Please fill in all required fields');
                console.log('Missing required fields:', runData);
                return;
            }
            
            const totals = calculateRunTotals(runData);
            console.log('Calculated totals:', totals);
            
            const run = {
                id: Date.now(),
                customerName: runData.customerName,
                company: runData.company,
                vehicleType: runData.vehicleType,
                passengers: runData.passengers,
                date: runData.date,
                pickup: runData.pickup,
                dropoff: runData.dropoff,
                use407: runData.use407,
                toll407Amount: runData.toll407Amount,
                waitingIncrements: runData.waitingIncrements,
                gratuityOverride: runData.gratuityOverride,
                paymentMethod: runData.paymentMethod,
                baseRate: totals.baseRate,
                airportFee: totals.airportFee,
                toll407: totals.toll407Amount,
                waitingFee: totals.waitingFee,
                gratuity: totals.gratuity,
                totalAmount: totals.totalAmount,
                myCommission: totals.myCommission
            };
            
            console.log('Final run object:', run);
            
            try {
                runs.push(run);
                localStorage.setItem('airportRuns', JSON.stringify(runs));
                console.log('Run saved to localStorage. Total runs:', runs.length);
                
                updateRunsTable();
                updateSummary();
                
                alert('Run added successfully!');
                
                // Switch to View Runs tab to show the new entry
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector('[onclick="switchTab(\'view-runs\')"]').classList.add('active');
                document.getElementById('view-runs').classList.add('active');
                
                resetForm();
            } catch (error) {
                console.error('Error saving run:', error);
                alert('Error saving run. Please try again.');
            }
        }
        
        function updateRunsTable() {
            const tbody = document.getElementById('runsTableBody');
            tbody.innerHTML = '';
            
            runs.forEach((run, index) => {
                const row = tbody.insertRow();
                row.className = run.paymentMethod === 'Cash' ? 'cash-payment' : 
                              run.paymentMethod === 'Credit Card' ? 'credit-payment' : 'account-payment';
                
                row.innerHTML = `
                    <td><input type="text" value="${run.customerName}" onchange="updateRun(${index}, 'customerName', this.value)"></td>
                    <td><select onchange="updateRun(${index}, 'company', this.value)">
                        <option value="360 Insights" ${run.company === '360 Insights' ? 'selected' : ''}>360 Insights</option>
                        <option value="Staples" ${run.company === 'Staples' ? 'selected' : ''}>Staples</option>
                        <option value="Ontario Shores" ${run.company === 'Ontario Shores' ? 'selected' : ''}>Ontario Shores</option>
                        <option value="OPG" ${run.company === 'OPG' ? 'selected' : ''}>OPG</option>
                        <option value="Expedia" ${run.company === 'Expedia' ? 'selected' : ''}>Expedia</option>
                        <option value="Gerdau" ${run.company === 'Gerdau' ? 'selected' : ''}>Gerdau</option>
                        <option value="Other" ${!['360 Insights', 'Staples', 'Ontario Shores', 'OPG', 'Expedia', 'Gerdau'].includes(run.company) ? 'selected' : ''}>Other</option>
                    </select></td>
                    <td><select onchange="updateRun(${index}, 'vehicleType', this.value)">
                        <option value="Sedan" ${run.vehicleType === 'Sedan' ? 'selected' : ''}>Sedan</option>
                        <option value="SUV" ${run.vehicleType === 'SUV' ? 'selected' : ''}>SUV</option>
                        <option value="Transit" ${run.vehicleType === 'Transit' ? 'selected' : ''}>Transit</option>
                    </select></td>
                    <td><input type="number" value="${run.passengers}" min="1" onchange="updateRun(${index}, 'passengers', parseInt(this.value))"></td>
                    <td><input type="date" value="${run.date}" onchange="updateRun(${index}, 'date', this.value)"></td>
                    <td><input type="text" value="${run.pickup}" onchange="updateRun(${index}, 'pickup', this.value)"></td>
                    <td><input type="text" value="${run.dropoff}" onchange="updateRun(${index}, 'dropoff', this.value)"></td>
                    <td><input type="number" value="${run.baseRate}" step="0.01" onchange="updateRun(${index}, 'baseRateOverride', parseFloat(this.value))"></td>
                    <td><input type="number" value="${run.toll407}" step="0.01" onchange="updateRun(${index}, 'toll407Amount', parseFloat(this.value))"></td>
                    <td><input type="number" value="${run.airportFee}" step="0.01" onchange="updateRun(${index}, 'airportFee', parseFloat(this.value))"></td>
                    <td><input type="number" value="${run.waitingFee}" step="0.01" onchange="updateRun(${index}, 'waitingFee', parseFloat(this.value))"></td>
                    <td><select onchange="updateRun(${index}, 'paymentMethod', this.value)">
                        <option value="Cash" ${run.paymentMethod === 'Cash' ? 'selected' : ''}>Cash</option>
                        <option value="Credit Card" ${run.paymentMethod === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                        <option value="On Account" ${run.paymentMethod === 'On Account' ? 'selected' : ''}>On Account</option>
                    </select></td>
                    <td><input type="number" value="${run.gratuity}" step="0.01" onchange="updateRun(${index}, 'gratuityOverride', parseFloat(this.value))"></td>
                    <td>${run.totalAmount.toFixed(2)}</td>
                    <td>${run.myCommission.toFixed(2)}</td>
                    <td>
                        <button class="save-btn" onclick="recalculateRun(${index})">Recalc</button>
                        <button class="delete-btn" onclick="deleteRun(${run.id})">Delete</button>
                    </td>
                `;
            });
        }
        
        function updateRun(index, field, value) {
            runs[index][field] = value;
            localStorage.setItem('airportRuns', JSON.stringify(runs));
        }
        
        function recalculateRun(index) {
            const run = runs[index];
            const totals = calculateRunTotals(run);
            
            runs[index].baseRate = totals.baseRate;
            runs[index].airportFee = totals.airportFee;
            runs[index].toll407 = totals.toll407Amount;
            runs[index].waitingFee = totals.waitingFee;
            runs[index].gratuity = totals.gratuity;
            runs[index].totalAmount = totals.totalAmount;
            runs[index].myCommission = totals.myCommission;
            
            localStorage.setItem('airportRuns', JSON.stringify(runs));
            updateRunsTable();
            updateSummary();
            
            alert('Run recalculated!');
        }
        
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const expense = {
                id: Date.now(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value)
            };
            
            expenses.push(expense);
            localStorage.setItem('airportExpenses', JSON.stringify(expenses));
            
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            updateExpensesTable();
            updateSummary();
            
            alert('Expense added successfully!');
        });
        
        function updateExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            tbody.innerHTML = '';
            
            expenses.forEach(expense => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.description}</td>
                    <td>${expense.amount.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteExpense(${expense.id})">Delete</button></td>
                `;
            });
        }
        
        function deleteRun(id) {
            if (confirm('Are you sure you want to delete this run?')) {
                runs = runs.filter(run => run.id !== id);
                localStorage.setItem('airportRuns', JSON.stringify(runs));
                updateRunsTable();
                updateSummary();
            }
        }
        
        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(expense => expense.id !== id);
                localStorage.setItem('airportExpenses', JSON.stringify(expenses));
                updateExpensesTable();
                updateSummary();
            }
        }
        
        function filterRunsByWeek() {
            const weekFilter = document.getElementById('weekFilter').value;
            if (!weekFilter) return;
            
            const [year, week] = weekFilter.split('-W');
            const startOfWeek = getDateOfWeek(year, week);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            const tbody = document.getElementById('runsTableBody');
            tbody.innerHTML = '';
            
            const filteredRuns = runs.filter(run => {
                const runDate = new Date(run.date);
                return runDate >= startOfWeek && runDate <= endOfWeek;
            });
            
            filteredRuns.forEach((run, originalIndex) => {
                const globalIndex = runs.findIndex(r => r.id === run.id);
                const row = tbody.insertRow();
                row.className = run.paymentMethod === 'Cash' ? 'cash-payment' : 
                              run.paymentMethod === 'Credit Card' ? 'credit-payment' : 'account-payment';
                
                row.innerHTML = `
                    <td><input type="text" value="${run.customerName}" onchange="updateRun(${globalIndex}, 'customerName', this.value)"></td>
                    <td><select onchange="updateRun(${globalIndex}, 'company', this.value)">
                        <option value="360 Insights" ${run.company === '360 Insights' ? 'selected' : ''}>360 Insights</option>
                        <option value="Staples" ${run.company === 'Staples' ? 'selected' : ''}>Staples</option>
                        <option value="Ontario Shores" ${run.company === 'Ontario Shores' ? 'selected' : ''}>Ontario Shores</option>
                        <option value="OPG" ${run.company === 'OPG' ? 'selected' : ''}>OPG</option>
                        <option value="Expedia" ${run.company === 'Expedia' ? 'selected' : ''}>Expedia</option>
                        <option value="Gerdau" ${run.company === 'Gerdau' ? 'selected' : ''}>Gerdau</option>
                        <option value="Other" ${!['360 Insights', 'Staples', 'Ontario Shores', 'OPG', 'Expedia', 'Gerdau'].includes(run.company) ? 'selected' : ''}>Other</option>
                    </select></td>
                    <td><select onchange="updateRun(${globalIndex}, 'vehicleType', this.value)">
                        <option value="Sedan" ${run.vehicleType === 'Sedan' ? 'selected' : ''}>Sedan</option>
                        <option value="SUV" ${run.vehicleType === 'SUV' ? 'selected' : ''}>SUV</option>
                        <option value="Transit" ${run.vehicleType === 'Transit' ? 'selected' : ''}>Transit</option>
                    </select></td>
                    <td><input type="number" value="${run.passengers}" min="1" onchange="updateRun(${globalIndex}, 'passengers', parseInt(this.value))"></td>
                    <td><input type="date" value="${run.date}" onchange="updateRun(${globalIndex}, 'date', this.value)"></td>
                    <td><input type="text" value="${run.pickup}" onchange="updateRun(${globalIndex}, 'pickup', this.value)"></td>
                    <td><input type="text" value="${run.dropoff}" onchange="updateRun(${globalIndex}, 'dropoff', this.value)"></td>
                    <td><input type="number" value="${run.baseRate}" step="0.01" onchange="updateRun(${globalIndex}, 'baseRateOverride', parseFloat(this.value))"></td>
                    <td><input type="number" value="${run.toll407}" step="0.01" onchange="updateRun(${globalIndex}, 'toll407Amount', parseFloat(this.value))"></td>
                    <td><input type="number" value="${run.airportFee}" step="0.01" onchange="updateRun(${globalIndex}, 'airportFee', parseFloat(this.value))"></td>
                    <td><input type="number" value="${run.waitingFee}" step="0.01" onchange="updateRun(${globalIndex}, 'waitingFee', parseFloat(this.value))"></td>
                    <td><select onchange="updateRun(${globalIndex}, 'paymentMethod', this.value)">
                        <option value="Cash" ${run.paymentMethod === 'Cash' ? 'selected' : ''}>Cash</option>
                        <option value="Credit Card" ${run.paymentMethod === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                        <option value="On Account" ${run.paymentMethod === 'On Account' ? 'selected' : ''}>On Account</option>
                    </select></td>
                    <td><input type="number" value="${run.gratuity}" step="0.01" onchange="updateRun(${globalIndex}, 'gratuityOverride', parseFloat(this.value))"></td>
                    <td>${run.totalAmount.toFixed(2)}</td>
                    <td>${run.myCommission.toFixed(2)}</td>
                    <td>
                        <button class="save-btn" onclick="recalculateRun(${globalIndex})">Recalc</button>
                        <button class="delete-btn" onclick="deleteRun(${run.id})">Delete</button>
                    </td>
                `;
            });
        }
        
        function clearWeekFilter() {
            document.getElementById('weekFilter').value = '';
            updateRunsTable();
        }
        
        function clearSummaryFilter() {
            document.getElementById('summaryWeekFilter').value = '';
            updateSummary();
        }
        
        function getDateOfWeek(year, week) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }
        
        function updateSummary() {
            const weekFilter = document.getElementById('summaryWeekFilter').value;
            let filteredRuns = runs;
            let filteredExpenses = expenses;
            
            if (weekFilter) {
                const [year, week] = weekFilter.split('-W');
                const startOfWeek = getDateOfWeek(year, week);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                
                filteredRuns = runs.filter(run => {
                    const runDate = new Date(run.date);
                    return runDate >= startOfWeek && runDate <= endOfWeek;
                });
                
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startOfWeek && expenseDate <= endOfWeek;
                });
            }
            
            const totalRuns = filteredRuns.length;
            const totalRevenue = filteredRuns.reduce((sum, run) => sum + run.totalAmount, 0);
            const totalBaseRuns = filteredRuns.reduce((sum, run) => sum + run.baseRate + run.waitingFee, 0);
            const totalTips = filteredRuns.reduce((sum, run) => sum + run.gratuity, 0);
            const totalExtras = filteredRuns.reduce((sum, run) => sum + run.airportFee + run.toll407, 0);
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const myCommission = (totalBaseRuns * 0.4) + totalTips;
            
            const cashRuns = filteredRuns.filter(run => run.paymentMethod === 'Cash');
            const totalCashCollected = cashRuns.reduce((sum, run) => sum + run.totalAmount - run.gratuity, 0);
            
            const amountIReceive = myCommission - totalExpenses;
            const balanceWithCompany = totalCashCollected - amountIReceive;
            
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <div class="summary-row">
                    <span>Total Runs:</span>
                    <span>${totalRuns}</span>
                </div>
                <div class="summary-row">
                    <span>Total Revenue:</span>
                    <span>${totalRevenue.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>Base Runs + Waiting:</span>
                    <span>${totalBaseRuns.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>Total Tips:</span>
                    <span>${totalTips.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>Total Extras (407 + Airport):</span>
                    <span>${totalExtras.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>Total Expenses:</span>
                    <span>${totalExpenses.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>My Commission (40% runs + 100% tips):</span>
                    <span>${myCommission.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>Cash Collected (excluding tips):</span>
                    <span>${totalCashCollected.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>Amount I Should Receive:</span>
                    <span>${amountIReceive.toFixed(2)}</span>
                </div>
                <div class="summary-row total" style="color: ${balanceWithCompany >= 0 ? 'red' : 'green'}">
                    <span>${balanceWithCompany >= 0 ? 'I Owe Company:' : 'Company Owes Me:'}</span>
                    <span>${Math.abs(balanceWithCompany).toFixed(2)}</span>
                </div>
            `;
        }
        
        function exportToExcel() {
            const weekFilter = document.getElementById('summaryWeekFilter').value;
            let filteredRuns = runs;
            let filteredExpenses = expenses;
            let periodText = 'All Time';
            
            if (weekFilter) {
                const [year, week] = weekFilter.split('-W');
                const startOfWeek = getDateOfWeek(year, week);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                
                periodText = `Week ${week}, ${year}`;
                
                filteredRuns = runs.filter(run => {
                    const runDate = new Date(run.date);
                    return runDate >= startOfWeek && runDate <= endOfWeek;
                });
                
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startOfWeek && expenseDate <= endOfWeek;
                });
            }
            
            // BUG FIX 3: Replaced `\\n` with `\n` for proper newlines.
            let csvContent = `Airport Run Tracker - ${periodText}\n\n`;
            
            csvContent += 'Customer,Company,Vehicle,Passengers,Date,Pickup,Dropoff,Rate,407,Airport Fee,Waiting,Payment,Gratuity,Total,My Commission\n';
            filteredRuns.forEach(run => {
                csvContent += `"${run.customerName}","${run.company}","${run.vehicleType}",${run.passengers},"${run.date}","${run.pickup}","${run.dropoff}",${run.baseRate},${run.toll407},${run.airportFee},${run.waitingFee},"${run.paymentMethod}",${run.gratuity},${run.totalAmount},${run.myCommission}\n`;
            });
            
            csvContent += '\n\nSUMMARY\n';
            const totalRuns = filteredRuns.length;
            const totalRevenue = filteredRuns.reduce((sum, run) => sum + run.totalAmount, 0);
            const totalBaseRuns = filteredRuns.reduce((sum, run) => sum + run.baseRate + run.waitingFee, 0);
            const totalTips = filteredRuns.reduce((sum, run) => sum + run.gratuity, 0);
            const totalExtras = filteredRuns.reduce((sum, run) => sum + run.airportFee + run.toll407, 0);
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const myCommission = (totalBaseRuns * 0.4) + totalTips;
            const cashRuns = filteredRuns.filter(run => run.paymentMethod === 'Cash');
            const totalCashCollected = cashRuns.reduce((sum, run) => sum + run.totalAmount - run.gratuity, 0);
            const amountIReceive = myCommission - totalExpenses;
            const balanceWithCompany = totalCashCollected - amountIReceive;
            
            csvContent += `Total Runs,${totalRuns}\n`;
            csvContent += `Total Revenue,${totalRevenue.toFixed(2)}\n`;
            csvContent += `Base Runs + Waiting,${totalBaseRuns.toFixed(2)}\n`;
            csvContent += `Total Tips,${totalTips.toFixed(2)}\n`;
            csvContent += `Total Extras,${totalExtras.toFixed(2)}\n`;
            csvContent += `Total Expenses,${totalExpenses.toFixed(2)}\n`;
            csvContent += `My Commission,${myCommission.toFixed(2)}\n`;
            csvContent += `Cash Collected,${totalCashCollected.toFixed(2)}\n`;
            csvContent += `Amount I Should Receive,${amountIReceive.toFixed(2)}\n`;
            csvContent += `${balanceWithCompany >= 0 ? 'I Owe Company' : 'Company Owes Me'},${Math.abs(balanceWithCompany).toFixed(2)}\n`;
            
            if (filteredExpenses.length > 0) {
                csvContent += '\n\nEXPENSES\n';
                csvContent += 'Date,Description,Amount\n';
                filteredExpenses.forEach(expense => {
                    csvContent += `"${expense.date}","${expense.description}",${expense.amount}\n`;
                });
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `airport_runs_${periodText.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>